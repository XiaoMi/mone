/*
 *  Copyright 2020 Xiaomi
 *
 *    Licensed under the Apache License, Version 2.0 (the "License");
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *        http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an "AS IS" BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */

package com.xiaomi.youpin.gateway.netty.filter.request;

import com.google.common.collect.Maps;
import com.google.gson.Gson;
import com.xiaomi.data.push.redis.Redis;
import com.xiaomi.youpin.gateway.common.*;
import com.xiaomi.youpin.gateway.dubbo.Dubbo;
import com.xiaomi.youpin.gateway.filter.FilterContext;
import com.xiaomi.youpin.gateway.filter.Invoker;
import com.xiaomi.youpin.gateway.filter.RequestFilter;
import com.xiaomi.youpin.gateway.http.Http;
import com.xiaomi.youpin.gateway.function.imp.RocketMqImp;
import com.xiaomi.youpin.gateway.nacos.Nacos;
import com.xiaomi.youpin.infra.rpc.Result;
import com.xiaomi.youpin.infra.rpc.errors.GeneralCodes;
import com.youpin.xiaomi.tesla.bo.*;
import io.netty.handler.codec.http.FullHttpRequest;
import io.netty.handler.codec.http.FullHttpResponse;
import lombok.extern.slf4j.Slf4j;
import org.apache.rocketmq.client.producer.DefaultMQProducer;
import org.nutz.dao.Dao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Map;
import java.util.stream.Collectors;

/**
 * @author goodjava@qq.com
 * <p>
 * 执行脚本
 */
@FilterOrder(2500)
@Component
@Slf4j
public class ScriptFilter extends RequestFilter {

    @Autowired
    private ScriptManager scriptManager;

    @Autowired
    private Redis redis;

    @Autowired
    private Dubbo dubbo;

    @Autowired
    private Nacos nacos;

    @Autowired
    private Dao dao;

    @Autowired
    private RocketMqImp rocketMq;

    @Autowired
    private Http http;

    @Override
    public FullHttpResponse doFilter(FilterContext context, Invoker invoker, ApiInfo apiInfo, FullHttpRequest request) {
        if (apiInfo.isAllow(Flag.ALLOW_SCRIPT)) {
            ScriptDebug scriptDebug = new ScriptDebug();
            try {
                log.info("invoke script:{}", apiInfo.getId());
                ScriptInfo info = scriptManager.loadScriptInfo(apiInfo.getId());
                int type = info.getScriptType();
                //当function执行
                if (type == ScriptType.Function.ordinal()) {
                    Map<String, Object> bindMap = Maps.newHashMap();
                    inject(context, request, scriptDebug, info, bindMap);
                    log.info("invoke method:{} {}", apiInfo.getId(), info.getMethodName());
                    Object res = scriptManager.invoke(info.getScript(), info.getMethodName(), bindMap, info.getParams().toArray());
                    return HttpResponseUtils.create(context.byteBuf(new Gson().toJson(res).getBytes()));
                }
                //前置执行
                if (type == ScriptType.Before.ordinal()) {
                    Map<String, Object> bindMap = Maps.newHashMap();
                    inject(context, request, scriptDebug, info, bindMap);
                    scriptManager.invokeBefore(info.getScript(), apiInfo, request, bindMap);
                    return invoker.doInvoker(context, apiInfo, request);
                }
                //后置执行
                if (type == ScriptType.After.ordinal()) {
                    FullHttpResponse res = invoker.doInvoker(context, apiInfo, request);
                    String content = HttpResponseUtils.getContent(res);
                    Map<String, Object> bindMap = Maps.newHashMap();
                    inject(context, request, scriptDebug, info, bindMap);
                    Object r = scriptManager.invokeAfter(info.getScript(), apiInfo, request, content, bindMap);
                    return HttpResponseUtils.create(context.byteBuf(r.toString().getBytes()));
                }
                //环绕执行
                if (type == ScriptType.Around.ordinal()) {
                    Map<String, Object> bindMap = Maps.newHashMap();
                    inject(context, request, scriptDebug, info, bindMap);
                    scriptManager.invokeBefore(info.getScript(), apiInfo, request, bindMap);
                    FullHttpResponse res = invoker.doInvoker(context, apiInfo, request);
                    String content = HttpResponseUtils.getContent(res);
                    return HttpResponseUtils.create(context.byteBuf(scriptManager.invokeAfter(info.getScript(), apiInfo, request, content, bindMap).toString().getBytes()));
                }

            } catch (Throwable ex) {
                log.warn("invoke script error:" + ex.getMessage(), ex);
                return HttpResponseUtils.create(Result.fail(GeneralCodes.InternalError, Msg.msgFor500, "invoke script error:" + ex.getMessage()));
            } finally {
                if (request.headers().get("Script-Debug") != null && request.headers().get("Script-Debug").equals("on")) {
                    redis.set(Keys.scriptDebugKey(String.valueOf(apiInfo.getId())), scriptDebug.getStringBuffer().toString());
                }
            }
        }

        return invoker.doInvoker(context, apiInfo, request);
    }

    private void inject(FilterContext context, FullHttpRequest request, ScriptDebug scriptDebug, ScriptInfo info, Map<String, Object> bindMap) {
        bindMap.put("sRequest", initScriptRequest(context, request));
        bindMap.put("request", request);
        bindMap.put("scriptInfo", info);
        //日志
        bindMap.put("log", log);
        //script的调试信息
        bindMap.put("scriptDebug", scriptDebug);
        //cache调用
        bindMap.put("redis", redis);
        //dubbo调用
        bindMap.put("dubbo", dubbo);
        //配置调用
        bindMap.put("nacos", nacos);
        //数据库调用
        bindMap.put("sql", dao);
        //http调用
        bindMap.put("http", http);
        //rocketMq
        bindMap.put("mq", rocketMq);
    }

    private ScriptRequest initScriptRequest(FilterContext context, FullHttpRequest request) {
        ScriptRequest req = new ScriptRequest();

        try {
            req.setIp(context.getIp());
            req.setTraceId(HttpRequestUtils.traceId(request));
            req.setUid(context.getUid());
            req.setAttachments(context.getAttachments());

            Map<String, String> headers = request.headers().entries()
                    .stream().collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue, (e1, e2) -> e1));
            req.setHeader(headers);

            if (request.method().toString().toUpperCase().equals("GET")) {
                req.setGetParam(HttpRequestUtils.getQueryParams(request.uri()));
            } else {
                req.setFormParam(HttpRequestUtils.getFormBody(request));
                req.setPostParam(new String(HttpRequestUtils.getRequestBody(request)));
            }
        } catch (Exception e) {
            log.error("initScriptRequest error... ", e);
        }

        return req;
    }
}
