<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ExtensionLoader.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">dubbo-remoting-zookeeper</a> &gt; <a href="../index.html" class="el_bundle">dubbo-common</a> &gt; <a href="index.source.html" class="el_package">org.apache.dubbo.common.extension</a> &gt; <span class="el_source">ExtensionLoader.java</span></div><h1>ExtensionLoader.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.dubbo.common.extension;

import org.apache.dubbo.common.Constants;
import org.apache.dubbo.common.URL;
import org.apache.dubbo.common.extension.support.ActivateComparator;
import org.apache.dubbo.common.logger.Logger;
import org.apache.dubbo.common.logger.LoggerFactory;
import org.apache.dubbo.common.utils.ClassHelper;
import org.apache.dubbo.common.utils.ConcurrentHashSet;
import org.apache.dubbo.common.utils.ConfigUtils;
import org.apache.dubbo.common.utils.Holder;
import org.apache.dubbo.common.utils.StringUtils;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeSet;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.regex.Pattern;

/**
 * Load dubbo extensions
 * &lt;ul&gt;
 * &lt;li&gt;auto inject dependency extension &lt;/li&gt;
 * &lt;li&gt;auto wrap extension in wrapper &lt;/li&gt;
 * &lt;li&gt;default extension is an adaptive instance&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @see &lt;a href=&quot;http://java.sun.com/j2se/1.5.0/docs/guide/jar/jar.html#Service%20Provider&quot;&gt;Service Provider in Java 5&lt;/a&gt;
 * @see org.apache.dubbo.common.extension.SPI
 * @see org.apache.dubbo.common.extension.Adaptive
 * @see org.apache.dubbo.common.extension.Activate
 */
public class ExtensionLoader&lt;T&gt; {

<span class="nc" id="L62">    private static final Logger logger = LoggerFactory.getLogger(ExtensionLoader.class);</span>

    private static final String SERVICES_DIRECTORY = &quot;META-INF/services/&quot;;

    private static final String DUBBO_DIRECTORY = &quot;META-INF/dubbo/&quot;;

    private static final String DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + &quot;internal/&quot;;

<span class="nc" id="L70">    private static final Pattern NAME_SEPARATOR = Pattern.compile(&quot;\\s*[,]+\\s*&quot;);</span>

<span class="nc" id="L72">    private static final ConcurrentMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; EXTENSION_LOADERS = new ConcurrentHashMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt;();</span>

<span class="nc" id="L74">    private static final ConcurrentMap&lt;Class&lt;?&gt;, Object&gt; EXTENSION_INSTANCES = new ConcurrentHashMap&lt;Class&lt;?&gt;, Object&gt;();</span>

    // ==============================

    private final Class&lt;?&gt; type;

    private final ExtensionFactory objectFactory;

<span class="nc" id="L82">    private final ConcurrentMap&lt;Class&lt;?&gt;, String&gt; cachedNames = new ConcurrentHashMap&lt;Class&lt;?&gt;, String&gt;();</span>

<span class="nc" id="L84">    private final Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt; cachedClasses = new Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt;();</span>

<span class="nc" id="L86">    private final Map&lt;String, Object&gt; cachedActivates = new ConcurrentHashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L87">    private final ConcurrentMap&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = new ConcurrentHashMap&lt;String, Holder&lt;Object&gt;&gt;();</span>
<span class="nc" id="L88">    private final Holder&lt;Object&gt; cachedAdaptiveInstance = new Holder&lt;Object&gt;();</span>
<span class="nc" id="L89">    private volatile Class&lt;?&gt; cachedAdaptiveClass = null;</span>
    private String cachedDefaultName;
    private volatile Throwable createAdaptiveInstanceError;

    private Set&lt;Class&lt;?&gt;&gt; cachedWrapperClasses;

<span class="nc" id="L95">    private Map&lt;String, IllegalStateException&gt; exceptions = new ConcurrentHashMap&lt;String, IllegalStateException&gt;();</span>

<span class="nc" id="L97">    private ExtensionLoader(Class&lt;?&gt; type) {</span>
<span class="nc" id="L98">        this.type = type;</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        objectFactory = (type == ExtensionFactory.class ? null : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());</span>
<span class="nc" id="L100">    }</span>

    private static &lt;T&gt; boolean withExtensionAnnotation(Class&lt;T&gt; type) {
<span class="nc" id="L103">        return type.isAnnotationPresent(SPI.class);</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(Class&lt;T&gt; type) {
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (type == null) {</span>
<span class="nc" id="L109">            throw new IllegalArgumentException(&quot;Extension type == null&quot;);</span>
        }
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (!type.isInterface()) {</span>
<span class="nc" id="L112">            throw new IllegalArgumentException(&quot;Extension type(&quot; + type + &quot;) is not interface!&quot;);</span>
        }
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (!withExtensionAnnotation(type)) {</span>
<span class="nc" id="L115">            throw new IllegalArgumentException(&quot;Extension type(&quot; + type +</span>
<span class="nc" id="L116">                    &quot;) is not extension, because WITHOUT @&quot; + SPI.class.getSimpleName() + &quot; Annotation!&quot;);</span>
        }

<span class="nc" id="L119">        ExtensionLoader&lt;T&gt; loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (loader == null) {</span>
<span class="nc" id="L121">            EXTENSION_LOADERS.putIfAbsent(type, new ExtensionLoader&lt;T&gt;(type));</span>
<span class="nc" id="L122">            loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);</span>
        }
<span class="nc" id="L124">        return loader;</span>
    }

    // For testing purposes only
    public static void resetExtensionLoader(Class type) {
<span class="nc" id="L129">        ExtensionLoader loader = EXTENSION_LOADERS.get(type);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (loader != null) {</span>
            // Remove all instances associated with this loader as well
<span class="nc" id="L132">            Map&lt;String, Class&lt;?&gt;&gt; classes = loader.getExtensionClasses();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">            for (Map.Entry&lt;String, Class&lt;?&gt;&gt; entry : classes.entrySet()) {</span>
<span class="nc" id="L134">                EXTENSION_INSTANCES.remove(entry.getValue());</span>
<span class="nc" id="L135">            }</span>
<span class="nc" id="L136">            classes.clear();</span>
<span class="nc" id="L137">            EXTENSION_LOADERS.remove(type);</span>
        }
<span class="nc" id="L139">    }</span>

    private static ClassLoader findClassLoader() {
<span class="nc" id="L142">        return ClassHelper.getClassLoader(ExtensionLoader.class);</span>
    }

    public String getExtensionName(T extensionInstance) {
<span class="nc" id="L146">        return getExtensionName(extensionInstance.getClass());</span>
    }

    public String getExtensionName(Class&lt;?&gt; extensionClass) {
<span class="nc" id="L150">        getExtensionClasses();// load class</span>
<span class="nc" id="L151">        return cachedNames.get(extensionClass);</span>
    }

    /**
     * This is equivalent to {@code getActivateExtension(url, key, null)}
     *
     * @param url url
     * @param key url parameter key which used to get extension point names
     * @return extension list which are activated.
     * @see #getActivateExtension(org.apache.dubbo.common.URL, String, String)
     */
    public List&lt;T&gt; getActivateExtension(URL url, String key) {
<span class="nc" id="L163">        return getActivateExtension(url, key, null);</span>
    }

    /**
     * This is equivalent to {@code getActivateExtension(url, values, null)}
     *
     * @param url    url
     * @param values extension point names
     * @return extension list which are activated
     * @see #getActivateExtension(org.apache.dubbo.common.URL, String[], String)
     */
    public List&lt;T&gt; getActivateExtension(URL url, String[] values) {
<span class="nc" id="L175">        return getActivateExtension(url, values, null);</span>
    }

    /**
     * This is equivalent to {@code getActivateExtension(url, url.getParameter(key).split(&quot;,&quot;), null)}
     *
     * @param url   url
     * @param key   url parameter key which used to get extension point names
     * @param group group
     * @return extension list which are activated.
     * @see #getActivateExtension(org.apache.dubbo.common.URL, String[], String)
     */
    public List&lt;T&gt; getActivateExtension(URL url, String key, String group) {
<span class="nc" id="L188">        String value = url.getParameter(key);</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">        return getActivateExtension(url, value == null || value.length() == 0 ? null : Constants.COMMA_SPLIT_PATTERN.split(value), group);</span>
    }

    /**
     * Get activate extensions.
     *
     * @param url    url
     * @param values extension point names
     * @param group  group
     * @return extension list which are activated
     * @see org.apache.dubbo.common.extension.Activate
     */
    public List&lt;T&gt; getActivateExtension(URL url, String[] values, String group) {
<span class="nc" id="L202">        List&lt;T&gt; exts = new ArrayList&lt;T&gt;();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        List&lt;String&gt; names = values == null ? new ArrayList&lt;String&gt;(0) : Arrays.asList(values);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (!names.contains(Constants.REMOVE_VALUE_PREFIX + Constants.DEFAULT_KEY)) {</span>
<span class="nc" id="L205">            getExtensionClasses();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            for (Map.Entry&lt;String, Object&gt; entry : cachedActivates.entrySet()) {</span>
<span class="nc" id="L207">                String name = entry.getKey();</span>
<span class="nc" id="L208">                Object activate = entry.getValue();</span>

                String[] activateGroup, activateValue;

<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (activate instanceof Activate) {</span>
<span class="nc" id="L213">                    activateGroup = ((Activate) activate).group();</span>
<span class="nc" id="L214">                    activateValue = ((Activate) activate).value();</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                } else if (activate instanceof com.alibaba.dubbo.common.extension.Activate) {</span>
<span class="nc" id="L216">                    activateGroup = ((com.alibaba.dubbo.common.extension.Activate) activate).group();</span>
<span class="nc" id="L217">                    activateValue = ((com.alibaba.dubbo.common.extension.Activate) activate).value();</span>
                } else {
                    continue;
                }
<span class="nc bnc" id="L221" title="All 2 branches missed.">                if (isMatchGroup(group, activateGroup)) {</span>
<span class="nc" id="L222">                    T ext = getExtension(name);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                    if (!names.contains(name)</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                            &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name)</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                            &amp;&amp; isActive(activateValue, url)) {</span>
<span class="nc" id="L226">                        exts.add(ext);</span>
                    }
                }
<span class="nc" id="L229">            }</span>
<span class="nc" id="L230">            Collections.sort(exts, ActivateComparator.COMPARATOR);</span>
        }
<span class="nc" id="L232">        List&lt;T&gt; usrs = new ArrayList&lt;T&gt;();</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        for (int i = 0; i &lt; names.size(); i++) {</span>
<span class="nc" id="L234">            String name = names.get(i);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">            if (!name.startsWith(Constants.REMOVE_VALUE_PREFIX)</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                    &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name)) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                if (Constants.DEFAULT_KEY.equals(name)) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                    if (!usrs.isEmpty()) {</span>
<span class="nc" id="L239">                        exts.addAll(0, usrs);</span>
<span class="nc" id="L240">                        usrs.clear();</span>
                    }
                } else {
<span class="nc" id="L243">                    T ext = getExtension(name);</span>
<span class="nc" id="L244">                    usrs.add(ext);</span>
                }
            }
        }
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (!usrs.isEmpty()) {</span>
<span class="nc" id="L249">            exts.addAll(usrs);</span>
        }
<span class="nc" id="L251">        return exts;</span>
    }

    private boolean isMatchGroup(String group, String[] groups) {
<span class="nc bnc" id="L255" title="All 4 branches missed.">        if (group == null || group.length() == 0) {</span>
<span class="nc" id="L256">            return true;</span>
        }
<span class="nc bnc" id="L258" title="All 4 branches missed.">        if (groups != null &amp;&amp; groups.length &gt; 0) {</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">            for (String g : groups) {</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                if (group.equals(g)) {</span>
<span class="nc" id="L261">                    return true;</span>
                }
            }
        }
<span class="nc" id="L265">        return false;</span>
    }

    private boolean isActive(String[] keys, URL url) {
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (keys.length == 0) {</span>
<span class="nc" id="L270">            return true;</span>
        }
<span class="nc bnc" id="L272" title="All 2 branches missed.">        for (String key : keys) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            for (Map.Entry&lt;String, String&gt; entry : url.getParameters().entrySet()) {</span>
<span class="nc" id="L274">                String k = entry.getKey();</span>
<span class="nc" id="L275">                String v = entry.getValue();</span>
<span class="nc bnc" id="L276" title="All 4 branches missed.">                if ((k.equals(key) || k.endsWith(&quot;.&quot; + key))</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">                        &amp;&amp; ConfigUtils.isNotEmpty(v)) {</span>
<span class="nc" id="L278">                    return true;</span>
                }
<span class="nc" id="L280">            }</span>
        }
<span class="nc" id="L282">        return false;</span>
    }

    /**
     * Get extension's instance. Return &lt;code&gt;null&lt;/code&gt; if extension is not found or is not initialized. Pls. note
     * that this method will not trigger extension load.
     * &lt;p&gt;
     * In order to trigger extension load, call {@link #getExtension(String)} instead.
     *
     * @see #getExtension(String)
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public T getLoadedExtension(String name) {
<span class="nc bnc" id="L295" title="All 4 branches missed.">        if (name == null || name.length() == 0) {</span>
<span class="nc" id="L296">            throw new IllegalArgumentException(&quot;Extension name == null&quot;);</span>
        }
<span class="nc" id="L298">        Holder&lt;Object&gt; holder = cachedInstances.get(name);</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (holder == null) {</span>
<span class="nc" id="L300">            cachedInstances.putIfAbsent(name, new Holder&lt;Object&gt;());</span>
<span class="nc" id="L301">            holder = cachedInstances.get(name);</span>
        }
<span class="nc" id="L303">        return (T) holder.get();</span>
    }

    /**
     * Return the list of extensions which are already loaded.
     * &lt;p&gt;
     * Usually {@link #getSupportedExtensions()} should be called in order to get all extensions.
     *
     * @see #getSupportedExtensions()
     */
    public Set&lt;String&gt; getLoadedExtensions() {
<span class="nc" id="L314">        return Collections.unmodifiableSet(new TreeSet&lt;String&gt;(cachedInstances.keySet()));</span>
    }

    /**
     * Find the extension with the given name. If the specified name is not found, then {@link IllegalStateException}
     * will be thrown.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public T getExtension(String name) {
<span class="nc bnc" id="L323" title="All 4 branches missed.">        if (name == null || name.length() == 0) {</span>
<span class="nc" id="L324">            throw new IllegalArgumentException(&quot;Extension name == null&quot;);</span>
        }
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (&quot;true&quot;.equals(name)) {</span>
<span class="nc" id="L327">            return getDefaultExtension();</span>
        }
<span class="nc" id="L329">        Holder&lt;Object&gt; holder = cachedInstances.get(name);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (holder == null) {</span>
<span class="nc" id="L331">            cachedInstances.putIfAbsent(name, new Holder&lt;Object&gt;());</span>
<span class="nc" id="L332">            holder = cachedInstances.get(name);</span>
        }
<span class="nc" id="L334">        Object instance = holder.get();</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (instance == null) {</span>
<span class="nc" id="L336">            synchronized (holder) {</span>
<span class="nc" id="L337">                instance = holder.get();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                if (instance == null) {</span>
<span class="nc" id="L339">                    instance = createExtension(name);</span>
<span class="nc" id="L340">                    holder.set(instance);</span>
                }
<span class="nc" id="L342">            }</span>
        }
<span class="nc" id="L344">        return (T) instance;</span>
    }

    /**
     * Return default extension, return &lt;code&gt;null&lt;/code&gt; if it's not configured.
     */
    public T getDefaultExtension() {
<span class="nc" id="L351">        getExtensionClasses();</span>
<span class="nc bnc" id="L352" title="All 4 branches missed.">        if (null == cachedDefaultName || cachedDefaultName.length() == 0</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                || &quot;true&quot;.equals(cachedDefaultName)) {</span>
<span class="nc" id="L354">            return null;</span>
        }
<span class="nc" id="L356">        return getExtension(cachedDefaultName);</span>
    }

    public boolean hasExtension(String name) {
<span class="nc bnc" id="L360" title="All 4 branches missed.">        if (name == null || name.length() == 0) {</span>
<span class="nc" id="L361">            throw new IllegalArgumentException(&quot;Extension name == null&quot;);</span>
        }
<span class="nc" id="L363">        Class&lt;?&gt; c = this.getExtensionClass(name);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">        return c != null;</span>
    }

    public Set&lt;String&gt; getSupportedExtensions() {
<span class="nc" id="L368">        Map&lt;String, Class&lt;?&gt;&gt; clazzes = getExtensionClasses();</span>
<span class="nc" id="L369">        return Collections.unmodifiableSet(new TreeSet&lt;String&gt;(clazzes.keySet()));</span>
    }

    /**
     * Return default extension name, return &lt;code&gt;null&lt;/code&gt; if not configured.
     */
    public String getDefaultExtensionName() {
<span class="nc" id="L376">        getExtensionClasses();</span>
<span class="nc" id="L377">        return cachedDefaultName;</span>
    }

    /**
     * Register new extension via API
     *
     * @param name  extension name
     * @param clazz extension class
     * @throws IllegalStateException when extension with the same name has already been registered.
     */
    public void addExtension(String name, Class&lt;?&gt; clazz) {
<span class="nc" id="L388">        getExtensionClasses(); // load classes</span>

<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (!type.isAssignableFrom(clazz)) {</span>
<span class="nc" id="L391">            throw new IllegalStateException(&quot;Input type &quot; +</span>
                    clazz + &quot;not implement Extension &quot; + type);
        }
<span class="nc bnc" id="L394" title="All 2 branches missed.">        if (clazz.isInterface()) {</span>
<span class="nc" id="L395">            throw new IllegalStateException(&quot;Input type &quot; +</span>
                    clazz + &quot;can not be interface!&quot;);
        }

<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (!clazz.isAnnotationPresent(Adaptive.class)) {</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">            if (StringUtils.isBlank(name)) {</span>
<span class="nc" id="L401">                throw new IllegalStateException(&quot;Extension name is blank (Extension &quot; + type + &quot;)!&quot;);</span>
            }
<span class="nc bnc" id="L403" title="All 2 branches missed.">            if (cachedClasses.get().containsKey(name)) {</span>
<span class="nc" id="L404">                throw new IllegalStateException(&quot;Extension name &quot; +</span>
                        name + &quot; already existed(Extension &quot; + type + &quot;)!&quot;);
            }

<span class="nc" id="L408">            cachedNames.put(clazz, name);</span>
<span class="nc" id="L409">            cachedClasses.get().put(name, clazz);</span>
        } else {
<span class="nc bnc" id="L411" title="All 2 branches missed.">            if (cachedAdaptiveClass != null) {</span>
<span class="nc" id="L412">                throw new IllegalStateException(&quot;Adaptive Extension already existed(Extension &quot; + type + &quot;)!&quot;);</span>
            }

<span class="nc" id="L415">            cachedAdaptiveClass = clazz;</span>
        }
<span class="nc" id="L417">    }</span>

    /**
     * Replace the existing extension via API
     *
     * @param name  extension name
     * @param clazz extension class
     * @throws IllegalStateException when extension to be placed doesn't exist
     * @deprecated not recommended any longer, and use only when test
     */
    @Deprecated
    public void replaceExtension(String name, Class&lt;?&gt; clazz) {
<span class="nc" id="L429">        getExtensionClasses(); // load classes</span>

<span class="nc bnc" id="L431" title="All 2 branches missed.">        if (!type.isAssignableFrom(clazz)) {</span>
<span class="nc" id="L432">            throw new IllegalStateException(&quot;Input type &quot; +</span>
                    clazz + &quot;not implement Extension &quot; + type);
        }
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (clazz.isInterface()) {</span>
<span class="nc" id="L436">            throw new IllegalStateException(&quot;Input type &quot; +</span>
                    clazz + &quot;can not be interface!&quot;);
        }

<span class="nc bnc" id="L440" title="All 2 branches missed.">        if (!clazz.isAnnotationPresent(Adaptive.class)) {</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            if (StringUtils.isBlank(name)) {</span>
<span class="nc" id="L442">                throw new IllegalStateException(&quot;Extension name is blank (Extension &quot; + type + &quot;)!&quot;);</span>
            }
<span class="nc bnc" id="L444" title="All 2 branches missed.">            if (!cachedClasses.get().containsKey(name)) {</span>
<span class="nc" id="L445">                throw new IllegalStateException(&quot;Extension name &quot; +</span>
                        name + &quot; not existed(Extension &quot; + type + &quot;)!&quot;);
            }

<span class="nc" id="L449">            cachedNames.put(clazz, name);</span>
<span class="nc" id="L450">            cachedClasses.get().put(name, clazz);</span>
<span class="nc" id="L451">            cachedInstances.remove(name);</span>
        } else {
<span class="nc bnc" id="L453" title="All 2 branches missed.">            if (cachedAdaptiveClass == null) {</span>
<span class="nc" id="L454">                throw new IllegalStateException(&quot;Adaptive Extension not existed(Extension &quot; + type + &quot;)!&quot;);</span>
            }

<span class="nc" id="L457">            cachedAdaptiveClass = clazz;</span>
<span class="nc" id="L458">            cachedAdaptiveInstance.set(null);</span>
        }
<span class="nc" id="L460">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public T getAdaptiveExtension() {
<span class="nc" id="L464">        Object instance = cachedAdaptiveInstance.get();</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (instance == null) {</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">            if (createAdaptiveInstanceError == null) {</span>
<span class="nc" id="L467">                synchronized (cachedAdaptiveInstance) {</span>
<span class="nc" id="L468">                    instance = cachedAdaptiveInstance.get();</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                    if (instance == null) {</span>
                        try {
<span class="nc" id="L471">                            instance = createAdaptiveExtension();</span>
<span class="nc" id="L472">                            cachedAdaptiveInstance.set(instance);</span>
<span class="nc" id="L473">                        } catch (Throwable t) {</span>
<span class="nc" id="L474">                            createAdaptiveInstanceError = t;</span>
<span class="nc" id="L475">                            throw new IllegalStateException(&quot;fail to create adaptive instance: &quot; + t.toString(), t);</span>
<span class="nc" id="L476">                        }</span>
                    }
<span class="nc" id="L478">                }</span>
            } else {
<span class="nc" id="L480">                throw new IllegalStateException(&quot;fail to create adaptive instance: &quot; + createAdaptiveInstanceError.toString(), createAdaptiveInstanceError);</span>
            }
        }

<span class="nc" id="L484">        return (T) instance;</span>
    }

    private IllegalStateException findException(String name) {
<span class="nc bnc" id="L488" title="All 2 branches missed.">        for (Map.Entry&lt;String, IllegalStateException&gt; entry : exceptions.entrySet()) {</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">            if (entry.getKey().toLowerCase().contains(name.toLowerCase())) {</span>
<span class="nc" id="L490">                return entry.getValue();</span>
            }
<span class="nc" id="L492">        }</span>
<span class="nc" id="L493">        StringBuilder buf = new StringBuilder(&quot;No such extension &quot; + type.getName() + &quot; by name &quot; + name);</span>


<span class="nc" id="L496">        int i = 1;</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">        for (Map.Entry&lt;String, IllegalStateException&gt; entry : exceptions.entrySet()) {</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">            if (i == 1) {</span>
<span class="nc" id="L499">                buf.append(&quot;, possible causes: &quot;);</span>
            }

<span class="nc" id="L502">            buf.append(&quot;\r\n(&quot;);</span>
<span class="nc" id="L503">            buf.append(i++);</span>
<span class="nc" id="L504">            buf.append(&quot;) &quot;);</span>
<span class="nc" id="L505">            buf.append(entry.getKey());</span>
<span class="nc" id="L506">            buf.append(&quot;:\r\n&quot;);</span>
<span class="nc" id="L507">            buf.append(StringUtils.toString(entry.getValue()));</span>
<span class="nc" id="L508">        }</span>
<span class="nc" id="L509">        return new IllegalStateException(buf.toString());</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private T createExtension(String name) {
<span class="nc" id="L514">        Class&lt;?&gt; clazz = getExtensionClasses().get(name);</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">        if (clazz == null) {</span>
<span class="nc" id="L516">            throw findException(name);</span>
        }
        try {
<span class="nc" id="L519">            T instance = (T) EXTENSION_INSTANCES.get(clazz);</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">            if (instance == null) {</span>
<span class="nc" id="L521">                EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());</span>
<span class="nc" id="L522">                instance = (T) EXTENSION_INSTANCES.get(clazz);</span>
            }
<span class="nc" id="L524">            injectExtension(instance);</span>
<span class="nc" id="L525">            Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;</span>
<span class="nc bnc" id="L526" title="All 4 branches missed.">            if (wrapperClasses != null &amp;&amp; !wrapperClasses.isEmpty()) {</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">                for (Class&lt;?&gt; wrapperClass : wrapperClasses) {</span>
<span class="nc" id="L528">                    instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</span>
<span class="nc" id="L529">                }</span>
            }
<span class="nc" id="L531">            return instance;</span>
<span class="nc" id="L532">        } catch (Throwable t) {</span>
<span class="nc" id="L533">            throw new IllegalStateException(&quot;Extension instance(name: &quot; + name + &quot;, class: &quot; +</span>
<span class="nc" id="L534">                    type + &quot;)  could not be instantiated: &quot; + t.getMessage(), t);</span>
        }
    }

    private T injectExtension(T instance) {
        try {
<span class="nc bnc" id="L540" title="All 2 branches missed.">            if (objectFactory != null) {</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">                for (Method method : instance.getClass().getMethods()) {</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                    if (method.getName().startsWith(&quot;set&quot;)</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">                            &amp;&amp; method.getParameterTypes().length == 1</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">                            &amp;&amp; Modifier.isPublic(method.getModifiers())) {</span>
                        /**
                         * Check {@link DisableInject} to see if we need auto injection for this property
                         */
<span class="nc bnc" id="L548" title="All 2 branches missed.">                        if (method.getAnnotation(DisableInject.class) != null) {</span>
<span class="nc" id="L549">                            continue;</span>
                        }
<span class="nc" id="L551">                        Class&lt;?&gt; pt = method.getParameterTypes()[0];</span>
                        try {
<span class="nc bnc" id="L553" title="All 2 branches missed.">                            String property = method.getName().length() &gt; 3 ? method.getName().substring(3, 4).toLowerCase() + method.getName().substring(4) : &quot;&quot;;</span>
<span class="nc" id="L554">                            Object object = objectFactory.getExtension(pt, property);</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">                            if (object != null) {</span>
<span class="nc" id="L556">                                method.invoke(instance, object);</span>
                            }
<span class="nc" id="L558">                        } catch (Exception e) {</span>
<span class="nc" id="L559">                            logger.error(&quot;fail to inject via method &quot; + method.getName()</span>
<span class="nc" id="L560">                                    + &quot; of interface &quot; + type.getName() + &quot;: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L561">                        }</span>
                    }
                }
            }
<span class="nc" id="L565">        } catch (Exception e) {</span>
<span class="nc" id="L566">            logger.error(e.getMessage(), e);</span>
<span class="nc" id="L567">        }</span>
<span class="nc" id="L568">        return instance;</span>
    }

    private Class&lt;?&gt; getExtensionClass(String name) {
<span class="nc bnc" id="L572" title="All 2 branches missed.">        if (type == null) {</span>
<span class="nc" id="L573">            throw new IllegalArgumentException(&quot;Extension type == null&quot;);</span>
        }
<span class="nc bnc" id="L575" title="All 2 branches missed.">        if (name == null) {</span>
<span class="nc" id="L576">            throw new IllegalArgumentException(&quot;Extension name == null&quot;);</span>
        }
<span class="nc" id="L578">        return getExtensionClasses().get(name);</span>
    }

    private Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() {
<span class="nc" id="L582">        Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">        if (classes == null) {</span>
<span class="nc" id="L584">            synchronized (cachedClasses) {</span>
<span class="nc" id="L585">                classes = cachedClasses.get();</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">                if (classes == null) {</span>
<span class="nc" id="L587">                    classes = loadExtensionClasses();</span>
<span class="nc" id="L588">                    cachedClasses.set(classes);</span>
                }
<span class="nc" id="L590">            }</span>
        }
<span class="nc" id="L592">        return classes;</span>
    }

    // synchronized in getExtensionClasses
    private Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() {
<span class="nc" id="L597">        final SPI defaultAnnotation = type.getAnnotation(SPI.class);</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">        if (defaultAnnotation != null) {</span>
<span class="nc" id="L599">            String value = defaultAnnotation.value();</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">            if ((value = value.trim()).length() &gt; 0) {</span>
<span class="nc" id="L601">                String[] names = NAME_SEPARATOR.split(value);</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">                if (names.length &gt; 1) {</span>
<span class="nc" id="L603">                    throw new IllegalStateException(&quot;more than 1 default extension name on extension &quot; + type.getName()</span>
<span class="nc" id="L604">                            + &quot;: &quot; + Arrays.toString(names));</span>
                }
<span class="nc bnc" id="L606" title="All 2 branches missed.">                if (names.length == 1) {</span>
<span class="nc" id="L607">                    cachedDefaultName = names[0];</span>
                }
            }
        }

<span class="nc" id="L612">        Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = new HashMap&lt;String, Class&lt;?&gt;&gt;();</span>
<span class="nc" id="L613">        loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY, type.getName());</span>
<span class="nc" id="L614">        loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY, type.getName().replace(&quot;org.apache&quot;, &quot;com.alibaba&quot;));</span>
<span class="nc" id="L615">        loadDirectory(extensionClasses, DUBBO_DIRECTORY, type.getName());</span>
<span class="nc" id="L616">        loadDirectory(extensionClasses, DUBBO_DIRECTORY, type.getName().replace(&quot;org.apache&quot;, &quot;com.alibaba&quot;));</span>
<span class="nc" id="L617">        loadDirectory(extensionClasses, SERVICES_DIRECTORY, type.getName());</span>
<span class="nc" id="L618">        loadDirectory(extensionClasses, SERVICES_DIRECTORY, type.getName().replace(&quot;org.apache&quot;, &quot;com.alibaba&quot;));</span>
<span class="nc" id="L619">        return extensionClasses;</span>
    }

    private void loadDirectory(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir, String type) {
<span class="nc" id="L623">        String fileName = dir + type;</span>
        try {
            Enumeration&lt;java.net.URL&gt; urls;
<span class="nc" id="L626">            ClassLoader classLoader = findClassLoader();</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">            if (classLoader != null) {</span>
<span class="nc" id="L628">                urls = classLoader.getResources(fileName);</span>
            } else {
<span class="nc" id="L630">                urls = ClassLoader.getSystemResources(fileName);</span>
            }
<span class="nc bnc" id="L632" title="All 2 branches missed.">            if (urls != null) {</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">                while (urls.hasMoreElements()) {</span>
<span class="nc" id="L634">                    java.net.URL resourceURL = urls.nextElement();</span>
<span class="nc" id="L635">                    loadResource(extensionClasses, classLoader, resourceURL);</span>
<span class="nc" id="L636">                }</span>
            }
<span class="nc" id="L638">        } catch (Throwable t) {</span>
<span class="nc" id="L639">            logger.error(&quot;Exception when load extension class(interface: &quot; +</span>
                    type + &quot;, description file: &quot; + fileName + &quot;).&quot;, t);
<span class="nc" id="L641">        }</span>
<span class="nc" id="L642">    }</span>

    private void loadResource(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, ClassLoader classLoader, java.net.URL resourceURL) {
        try {
<span class="nc" id="L646">            BufferedReader reader = new BufferedReader(new InputStreamReader(resourceURL.openStream(), &quot;utf-8&quot;));</span>
            try {
                String line;
<span class="nc bnc" id="L649" title="All 2 branches missed.">                while ((line = reader.readLine()) != null) {</span>
<span class="nc" id="L650">                    final int ci = line.indexOf('#');</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">                    if (ci &gt;= 0) {</span>
<span class="nc" id="L652">                        line = line.substring(0, ci);</span>
                    }
<span class="nc" id="L654">                    line = line.trim();</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">                    if (line.length() &gt; 0) {</span>
                        try {
<span class="nc" id="L657">                            String name = null;</span>
<span class="nc" id="L658">                            int i = line.indexOf('=');</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">                            if (i &gt; 0) {</span>
<span class="nc" id="L660">                                name = line.substring(0, i).trim();</span>
<span class="nc" id="L661">                                line = line.substring(i + 1).trim();</span>
                            }
<span class="nc bnc" id="L663" title="All 2 branches missed.">                            if (line.length() &gt; 0) {</span>
<span class="nc" id="L664">                                loadClass(extensionClasses, resourceURL, Class.forName(line, true, classLoader), name);</span>
                            }
<span class="nc" id="L666">                        } catch (Throwable t) {</span>
<span class="nc" id="L667">                            IllegalStateException e = new IllegalStateException(&quot;Failed to load extension class(interface: &quot; + type + &quot;, class line: &quot; + line + &quot;) in &quot; + resourceURL + &quot;, cause: &quot; + t.getMessage(), t);</span>
<span class="nc" id="L668">                            exceptions.put(line, e);</span>
<span class="nc" id="L669">                        }</span>
                    }
<span class="nc" id="L671">                }</span>
            } finally {
<span class="nc" id="L673">                reader.close();</span>
            }
<span class="nc" id="L675">        } catch (Throwable t) {</span>
<span class="nc" id="L676">            logger.error(&quot;Exception when load extension class(interface: &quot; +</span>
                    type + &quot;, class file: &quot; + resourceURL + &quot;) in &quot; + resourceURL, t);
<span class="nc" id="L678">        }</span>
<span class="nc" id="L679">    }</span>

    private void loadClass(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, java.net.URL resourceURL, Class&lt;?&gt; clazz, String name) throws NoSuchMethodException {
<span class="nc bnc" id="L682" title="All 2 branches missed.">        if (!type.isAssignableFrom(clazz)) {</span>
<span class="nc" id="L683">            throw new IllegalStateException(&quot;Error when load extension class(interface: &quot; +</span>
<span class="nc" id="L684">                    type + &quot;, class line: &quot; + clazz.getName() + &quot;), class &quot;</span>
<span class="nc" id="L685">                    + clazz.getName() + &quot;is not subtype of interface.&quot;);</span>
        }
<span class="nc bnc" id="L687" title="All 2 branches missed.">        if (clazz.isAnnotationPresent(Adaptive.class)) {</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">            if (cachedAdaptiveClass == null) {</span>
<span class="nc" id="L689">                cachedAdaptiveClass = clazz;</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">            } else if (!cachedAdaptiveClass.equals(clazz)) {</span>
<span class="nc" id="L691">                throw new IllegalStateException(&quot;More than 1 adaptive class found: &quot;</span>
<span class="nc" id="L692">                        + cachedAdaptiveClass.getClass().getName()</span>
<span class="nc" id="L693">                        + &quot;, &quot; + clazz.getClass().getName());</span>
            }
<span class="nc bnc" id="L695" title="All 2 branches missed.">        } else if (isWrapperClass(clazz)) {</span>
<span class="nc" id="L696">            Set&lt;Class&lt;?&gt;&gt; wrappers = cachedWrapperClasses;</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">            if (wrappers == null) {</span>
<span class="nc" id="L698">                cachedWrapperClasses = new ConcurrentHashSet&lt;Class&lt;?&gt;&gt;();</span>
<span class="nc" id="L699">                wrappers = cachedWrapperClasses;</span>
            }
<span class="nc" id="L701">            wrappers.add(clazz);</span>
<span class="nc" id="L702">        } else {</span>
<span class="nc" id="L703">            clazz.getConstructor();</span>
<span class="nc bnc" id="L704" title="All 4 branches missed.">            if (name == null || name.length() == 0) {</span>
<span class="nc" id="L705">                name = findAnnotationName(clazz);</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">                if (name.length() == 0) {</span>
<span class="nc" id="L707">                    throw new IllegalStateException(&quot;No such extension name for the class &quot; + clazz.getName() + &quot; in the config &quot; + resourceURL);</span>
                }
            }
<span class="nc" id="L710">            String[] names = NAME_SEPARATOR.split(name);</span>
<span class="nc bnc" id="L711" title="All 4 branches missed.">            if (names != null &amp;&amp; names.length &gt; 0) {</span>
<span class="nc" id="L712">                Activate activate = clazz.getAnnotation(Activate.class);</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                if (activate != null) {</span>
<span class="nc" id="L714">                    cachedActivates.put(names[0], activate);</span>
                } else {
                    // support com.alibaba.dubbo.common.extension.Activate
<span class="nc" id="L717">                    com.alibaba.dubbo.common.extension.Activate oldActivate = clazz.getAnnotation(com.alibaba.dubbo.common.extension.Activate.class);</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">                    if (oldActivate != null) {</span>
<span class="nc" id="L719">                        cachedActivates.put(names[0], oldActivate);</span>
                    }
                }
<span class="nc bnc" id="L722" title="All 2 branches missed.">                for (String n : names) {</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">                    if (!cachedNames.containsKey(clazz)) {</span>
<span class="nc" id="L724">                        cachedNames.put(clazz, n);</span>
                    }
<span class="nc" id="L726">                    Class&lt;?&gt; c = extensionClasses.get(n);</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">                    if (c == null) {</span>
<span class="nc" id="L728">                        extensionClasses.put(n, clazz);</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">                    } else if (c != clazz) {</span>
<span class="nc" id="L730">                        throw new IllegalStateException(&quot;Duplicate extension &quot; + type.getName() + &quot; name &quot; + n + &quot; on &quot; + c.getName() + &quot; and &quot; + clazz.getName());</span>
                    }
                }
            }
        }
<span class="nc" id="L735">    }</span>

    private boolean isWrapperClass(Class&lt;?&gt; clazz) {
        try {
<span class="nc" id="L739">            clazz.getConstructor(type);</span>
<span class="nc" id="L740">            return true;</span>
<span class="nc" id="L741">        } catch (NoSuchMethodException e) {</span>
<span class="nc" id="L742">            return false;</span>
        }
    }

    @SuppressWarnings(&quot;deprecation&quot;)
    private String findAnnotationName(Class&lt;?&gt; clazz) {
<span class="nc" id="L748">        org.apache.dubbo.common.Extension extension = clazz.getAnnotation(org.apache.dubbo.common.Extension.class);</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">        if (extension == null) {</span>
<span class="nc" id="L750">            String name = clazz.getSimpleName();</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">            if (name.endsWith(type.getSimpleName())) {</span>
<span class="nc" id="L752">                name = name.substring(0, name.length() - type.getSimpleName().length());</span>
            }
<span class="nc" id="L754">            return name.toLowerCase();</span>
        }
<span class="nc" id="L756">        return extension.value();</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private T createAdaptiveExtension() {
        try {
<span class="nc" id="L762">            return injectExtension((T) getAdaptiveExtensionClass().newInstance());</span>
<span class="nc" id="L763">        } catch (Exception e) {</span>
<span class="nc" id="L764">            throw new IllegalStateException(&quot;Can not create adaptive extension &quot; + type + &quot;, cause: &quot; + e.getMessage(), e);</span>
        }
    }

    private Class&lt;?&gt; getAdaptiveExtensionClass() {
<span class="nc" id="L769">        getExtensionClasses();</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">        if (cachedAdaptiveClass != null) {</span>
<span class="nc" id="L771">            return cachedAdaptiveClass;</span>
        }
<span class="nc" id="L773">        return cachedAdaptiveClass = createAdaptiveExtensionClass();</span>
    }

    private Class&lt;?&gt; createAdaptiveExtensionClass() {
<span class="nc" id="L777">        String code = createAdaptiveExtensionClassCode();</span>
<span class="nc" id="L778">        ClassLoader classLoader = findClassLoader();</span>
<span class="nc" id="L779">        org.apache.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(org.apache.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();</span>
<span class="nc" id="L780">        return compiler.compile(code, classLoader);</span>
    }

    private String createAdaptiveExtensionClassCode() {
<span class="nc" id="L784">        StringBuilder codeBuilder = new StringBuilder();</span>
<span class="nc" id="L785">        Method[] methods = type.getMethods();</span>
<span class="nc" id="L786">        boolean hasAdaptiveAnnotation = false;</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">        for (Method m : methods) {</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">            if (m.isAnnotationPresent(Adaptive.class)) {</span>
<span class="nc" id="L789">                hasAdaptiveAnnotation = true;</span>
<span class="nc" id="L790">                break;</span>
            }
        }
        // no need to generate adaptive class since there's no adaptive method found.
<span class="nc bnc" id="L794" title="All 2 branches missed.">        if (!hasAdaptiveAnnotation) {</span>
<span class="nc" id="L795">            throw new IllegalStateException(&quot;No adaptive method on extension &quot; + type.getName() + &quot;, refuse to create the adaptive class!&quot;);</span>
        }

<span class="nc" id="L798">        codeBuilder.append(&quot;package &quot;).append(type.getPackage().getName()).append(&quot;;&quot;);</span>
<span class="nc" id="L799">        codeBuilder.append(&quot;\nimport &quot;).append(ExtensionLoader.class.getName()).append(&quot;;&quot;);</span>
<span class="nc" id="L800">        codeBuilder.append(&quot;\npublic class &quot;).append(type.getSimpleName()).append(&quot;$Adaptive&quot;).append(&quot; implements &quot;).append(type.getCanonicalName()).append(&quot; {&quot;);</span>

<span class="nc" id="L802">        codeBuilder.append(&quot;\nprivate static final org.apache.dubbo.common.logger.Logger logger = org.apache.dubbo.common.logger.LoggerFactory.getLogger(ExtensionLoader.class);&quot;);</span>
<span class="nc" id="L803">        codeBuilder.append(&quot;\nprivate java.util.concurrent.atomic.AtomicInteger count = new java.util.concurrent.atomic.AtomicInteger(0);\n&quot;);</span>

<span class="nc bnc" id="L805" title="All 2 branches missed.">        for (Method method : methods) {</span>
<span class="nc" id="L806">            Class&lt;?&gt; rt = method.getReturnType();</span>
<span class="nc" id="L807">            Class&lt;?&gt;[] pts = method.getParameterTypes();</span>
<span class="nc" id="L808">            Class&lt;?&gt;[] ets = method.getExceptionTypes();</span>

<span class="nc" id="L810">            Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);</span>
<span class="nc" id="L811">            StringBuilder code = new StringBuilder(512);</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">            if (adaptiveAnnotation == null) {</span>
<span class="nc" id="L813">                code.append(&quot;throw new UnsupportedOperationException(\&quot;method &quot;)</span>
<span class="nc" id="L814">                        .append(method.toString()).append(&quot; of interface &quot;)</span>
<span class="nc" id="L815">                        .append(type.getName()).append(&quot; is not adaptive method!\&quot;);&quot;);</span>
            } else {
<span class="nc" id="L817">                int urlTypeIndex = -1;</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">                for (int i = 0; i &lt; pts.length; ++i) {</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">                    if (pts[i].equals(URL.class)) {</span>
<span class="nc" id="L820">                        urlTypeIndex = i;</span>
<span class="nc" id="L821">                        break;</span>
                    }
                }
                // found parameter in URL type
<span class="nc bnc" id="L825" title="All 2 branches missed.">                if (urlTypeIndex != -1) {</span>
                    // Null Point check
<span class="nc" id="L827">                    String s = String.format(&quot;\nif (arg%d == null) throw new IllegalArgumentException(\&quot;url == null\&quot;);&quot;,</span>
<span class="nc" id="L828">                            urlTypeIndex);</span>
<span class="nc" id="L829">                    code.append(s);</span>

<span class="nc" id="L831">                    s = String.format(&quot;\n%s url = arg%d;&quot;, URL.class.getName(), urlTypeIndex);</span>
<span class="nc" id="L832">                    code.append(s);</span>
<span class="nc" id="L833">                }</span>
                // did not find parameter in URL type
                else {
<span class="nc" id="L836">                    String attribMethod = null;</span>

                    // find URL getter method
                    LBL_PTS:
<span class="nc bnc" id="L840" title="All 2 branches missed.">                    for (int i = 0; i &lt; pts.length; ++i) {</span>
<span class="nc" id="L841">                        Method[] ms = pts[i].getMethods();</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">                        for (Method m : ms) {</span>
<span class="nc" id="L843">                            String name = m.getName();</span>
<span class="nc bnc" id="L844" title="All 4 branches missed.">                            if ((name.startsWith(&quot;get&quot;) || name.length() &gt; 3)</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">                                    &amp;&amp; Modifier.isPublic(m.getModifiers())</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">                                    &amp;&amp; !Modifier.isStatic(m.getModifiers())</span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">                                    &amp;&amp; m.getParameterTypes().length == 0</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">                                    &amp;&amp; m.getReturnType() == URL.class) {</span>
<span class="nc" id="L849">                                urlTypeIndex = i;</span>
<span class="nc" id="L850">                                attribMethod = name;</span>
<span class="nc" id="L851">                                break LBL_PTS;</span>
                            }
                        }
                    }
<span class="nc bnc" id="L855" title="All 2 branches missed.">                    if (attribMethod == null) {</span>
<span class="nc" id="L856">                        throw new IllegalStateException(&quot;fail to create adaptive class for interface &quot; + type.getName()</span>
<span class="nc" id="L857">                                + &quot;: not found url parameter or url attribute in parameters of method &quot; + method.getName());</span>
                    }

                    // Null point check
<span class="nc" id="L861">                    String s = String.format(&quot;\nif (arg%d == null) throw new IllegalArgumentException(\&quot;%s argument == null\&quot;);&quot;,</span>
<span class="nc" id="L862">                            urlTypeIndex, pts[urlTypeIndex].getName());</span>
<span class="nc" id="L863">                    code.append(s);</span>
<span class="nc" id="L864">                    s = String.format(&quot;\nif (arg%d.%s() == null) throw new IllegalArgumentException(\&quot;%s argument %s() == null\&quot;);&quot;,</span>
<span class="nc" id="L865">                            urlTypeIndex, attribMethod, pts[urlTypeIndex].getName(), attribMethod);</span>
<span class="nc" id="L866">                    code.append(s);</span>

<span class="nc" id="L868">                    s = String.format(&quot;%s url = arg%d.%s();&quot;, URL.class.getName(), urlTypeIndex, attribMethod);</span>
<span class="nc" id="L869">                    code.append(s);</span>
                }

<span class="nc" id="L872">                String[] value = adaptiveAnnotation.value();</span>
                // value is not set, use the value generated from class name as the key
<span class="nc bnc" id="L874" title="All 2 branches missed.">                if (value.length == 0) {</span>
<span class="nc" id="L875">                    String splitName = StringUtils.camelToSplitName(type.getSimpleName(), &quot;.&quot;);</span>
<span class="nc" id="L876">                    value = new String[]{splitName};</span>
                }

<span class="nc" id="L879">                boolean hasInvocation = false;</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">                for (int i = 0; i &lt; pts.length; ++i) {</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">                    if ((&quot;org.apache.dubbo.rpc.Invocation&quot;).equals(pts[i].getName())) {</span>
                        // Null Point check
<span class="nc" id="L883">                        String s = String.format(&quot;\nif (arg%d == null) throw new IllegalArgumentException(\&quot;invocation == null\&quot;);&quot;, i);</span>
<span class="nc" id="L884">                        code.append(s);</span>
<span class="nc" id="L885">                        s = String.format(&quot;\nString methodName = arg%d.getMethodName();&quot;, i);</span>
<span class="nc" id="L886">                        code.append(s);</span>
<span class="nc" id="L887">                        hasInvocation = true;</span>
<span class="nc" id="L888">                        break;</span>
                    }
                }

<span class="nc" id="L892">                String defaultExtName = cachedDefaultName;</span>
<span class="nc" id="L893">                String getNameCode = null;</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">                for (int i = value.length - 1; i &gt;= 0; --i) {</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">                    if (i == value.length - 1) {</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">                        if (null != defaultExtName) {</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">                            if (!&quot;protocol&quot;.equals(value[i])) {</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">                                if (hasInvocation) {</span>
<span class="nc" id="L899">                                    getNameCode = String.format(&quot;url.getMethodParameter(methodName, \&quot;%s\&quot;, \&quot;%s\&quot;)&quot;, value[i], defaultExtName);</span>
                                } else {
<span class="nc" id="L901">                                    getNameCode = String.format(&quot;url.getParameter(\&quot;%s\&quot;, \&quot;%s\&quot;)&quot;, value[i], defaultExtName);</span>
                                }
                            } else {
<span class="nc" id="L904">                                getNameCode = String.format(&quot;( url.getProtocol() == null ? \&quot;%s\&quot; : url.getProtocol() )&quot;, defaultExtName);</span>
                            }
                        } else {
<span class="nc bnc" id="L907" title="All 2 branches missed.">                            if (!&quot;protocol&quot;.equals(value[i])) {</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">                                if (hasInvocation) {</span>
<span class="nc" id="L909">                                    getNameCode = String.format(&quot;url.getMethodParameter(methodName, \&quot;%s\&quot;, \&quot;%s\&quot;)&quot;, value[i], defaultExtName);</span>
                                } else {
<span class="nc" id="L911">                                    getNameCode = String.format(&quot;url.getParameter(\&quot;%s\&quot;)&quot;, value[i]);</span>
                                }
                            } else {
<span class="nc" id="L914">                                getNameCode = &quot;url.getProtocol()&quot;;</span>
                            }
                        }
                    } else {
<span class="nc bnc" id="L918" title="All 2 branches missed.">                        if (!&quot;protocol&quot;.equals(value[i])) {</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">                            if (hasInvocation) {</span>
<span class="nc" id="L920">                                getNameCode = String.format(&quot;url.getMethodParameter(methodName, \&quot;%s\&quot;, \&quot;%s\&quot;)&quot;, value[i], defaultExtName);</span>
                            } else {
<span class="nc" id="L922">                                getNameCode = String.format(&quot;url.getParameter(\&quot;%s\&quot;, %s)&quot;, value[i], getNameCode);</span>
                            }
                        } else {
<span class="nc" id="L925">                            getNameCode = String.format(&quot;url.getProtocol() == null ? (%s) : url.getProtocol()&quot;, getNameCode);</span>
                        }
                    }
                }
<span class="nc" id="L929">                code.append(&quot;\nString extName = &quot;).append(getNameCode).append(&quot;;&quot;);</span>
                // check extName == null?
<span class="nc" id="L931">                String s = String.format(&quot;\nif(extName == null) &quot; +</span>
                                &quot;throw new IllegalStateException(\&quot;Fail to get extension(%s) name from url(\&quot; + url.toString() + \&quot;) use keys(%s)\&quot;);&quot;,
<span class="nc" id="L933">                        type.getName(), Arrays.toString(value));</span>
<span class="nc" id="L934">                code.append(s);</span>

<span class="nc" id="L936">                code.append(String.format(&quot;\n%s extension = null;\n try {\nextension = (%&lt;s)%s.getExtensionLoader(%s.class).getExtension(extName);\n}catch(Exception e){\n&quot;,</span>
<span class="nc" id="L937">                        type.getName(), ExtensionLoader.class.getSimpleName(), type.getName()));</span>
<span class="nc" id="L938">                code.append(String.format(&quot;if (count.incrementAndGet() == 1) {\nlogger.warn(\&quot;Failed to find extension named \&quot; + extName + \&quot; for type %s, will use default extension %s instead.\&quot;, e);\n}\n&quot;,</span>
<span class="nc" id="L939">                        type.getName(), defaultExtName));</span>
<span class="nc" id="L940">                code.append(String.format(&quot;extension = (%s)%s.getExtensionLoader(%s.class).getExtension(\&quot;%s\&quot;);\n}&quot;,</span>
<span class="nc" id="L941">                        type.getName(), ExtensionLoader.class.getSimpleName(), type.getName(), defaultExtName));</span>

                // return statement
<span class="nc bnc" id="L944" title="All 2 branches missed.">                if (!rt.equals(void.class)) {</span>
<span class="nc" id="L945">                    code.append(&quot;\nreturn &quot;);</span>
                }

<span class="nc" id="L948">                s = String.format(&quot;extension.%s(&quot;, method.getName());</span>
<span class="nc" id="L949">                code.append(s);</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">                for (int i = 0; i &lt; pts.length; i++) {</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">                    if (i != 0) {</span>
<span class="nc" id="L952">                        code.append(&quot;, &quot;);</span>
                    }
<span class="nc" id="L954">                    code.append(&quot;arg&quot;).append(i);</span>
                }
<span class="nc" id="L956">                code.append(&quot;);&quot;);</span>
            }

<span class="nc" id="L959">            codeBuilder.append(&quot;\npublic &quot;).append(rt.getCanonicalName()).append(&quot; &quot;).append(method.getName()).append(&quot;(&quot;);</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">            for (int i = 0; i &lt; pts.length; i++) {</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">                if (i &gt; 0) {</span>
<span class="nc" id="L962">                    codeBuilder.append(&quot;, &quot;);</span>
                }
<span class="nc" id="L964">                codeBuilder.append(pts[i].getCanonicalName());</span>
<span class="nc" id="L965">                codeBuilder.append(&quot; &quot;);</span>
<span class="nc" id="L966">                codeBuilder.append(&quot;arg&quot;).append(i);</span>
            }
<span class="nc" id="L968">            codeBuilder.append(&quot;)&quot;);</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">            if (ets.length &gt; 0) {</span>
<span class="nc" id="L970">                codeBuilder.append(&quot; throws &quot;);</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">                for (int i = 0; i &lt; ets.length; i++) {</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">                    if (i &gt; 0) {</span>
<span class="nc" id="L973">                        codeBuilder.append(&quot;, &quot;);</span>
                    }
<span class="nc" id="L975">                    codeBuilder.append(ets[i].getCanonicalName());</span>
                }
            }
<span class="nc" id="L978">            codeBuilder.append(&quot; {&quot;);</span>
<span class="nc" id="L979">            codeBuilder.append(code.toString());</span>
<span class="nc" id="L980">            codeBuilder.append(&quot;\n}&quot;);</span>
        }
<span class="nc" id="L982">        codeBuilder.append(&quot;\n}&quot;);</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L984">            logger.debug(codeBuilder.toString());</span>
        }
<span class="nc" id="L986">        return codeBuilder.toString();</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L991">        return this.getClass().getName() + &quot;[&quot; + type.getName() + &quot;]&quot;;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>