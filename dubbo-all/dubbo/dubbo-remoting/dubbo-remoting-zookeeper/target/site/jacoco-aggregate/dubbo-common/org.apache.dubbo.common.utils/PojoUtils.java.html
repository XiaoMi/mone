<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PojoUtils.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">dubbo-remoting-zookeeper</a> &gt; <a href="../index.html" class="el_bundle">dubbo-common</a> &gt; <a href="index.source.html" class="el_package">org.apache.dubbo.common.utils</a> &gt; <span class="el_source">PojoUtils.java</span></div><h1>PojoUtils.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.dubbo.common.utils;

import java.lang.reflect.Array;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.lang.reflect.ParameterizedType;
import java.lang.reflect.Proxy;
import java.lang.reflect.Type;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.IdentityHashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.TreeMap;
import java.util.WeakHashMap;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.ConcurrentSkipListMap;

/**
 * PojoUtils. Travel object deeply, and convert complex type to simple type.
 * &lt;p/&gt;
 * Simple type below will be remained:
 * &lt;ul&gt;
 * &lt;li&gt; Primitive Type, also include &lt;b&gt;String&lt;/b&gt;, &lt;b&gt;Number&lt;/b&gt;(Integer, Long), &lt;b&gt;Date&lt;/b&gt;
 * &lt;li&gt; Array of Primitive Type
 * &lt;li&gt; Collection, eg: List, Map, Set etc.
 * &lt;/ul&gt;
 * &lt;p/&gt;
 * Other type will be covert to a map which contains the attributes and value pair of object.
 */
<span class="nc" id="L58">public class PojoUtils {</span>

<span class="nc" id="L60">    private static final ConcurrentMap&lt;String, Method&gt; NAME_METHODS_CACHE = new ConcurrentHashMap&lt;String, Method&gt;();</span>
<span class="nc" id="L61">    private static final ConcurrentMap&lt;Class&lt;?&gt;, ConcurrentMap&lt;String, Field&gt;&gt; CLASS_FIELD_CACHE = new ConcurrentHashMap&lt;Class&lt;?&gt;, ConcurrentMap&lt;String, Field&gt;&gt;();</span>

    public static Object[] generalize(Object[] objs) {
<span class="nc" id="L64">        Object[] dests = new Object[objs.length];</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        for (int i = 0; i &lt; objs.length; i++) {</span>
<span class="nc" id="L66">            dests[i] = generalize(objs[i]);</span>
        }
<span class="nc" id="L68">        return dests;</span>
    }

    public static Object[] realize(Object[] objs, Class&lt;?&gt;[] types) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (objs.length != types.length) {</span>
<span class="nc" id="L73">            throw new IllegalArgumentException(&quot;args.length != types.length&quot;);</span>
        }

<span class="nc" id="L76">        Object[] dests = new Object[objs.length];</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        for (int i = 0; i &lt; objs.length; i++) {</span>
<span class="nc" id="L78">            dests[i] = realize(objs[i], types[i]);</span>
        }

<span class="nc" id="L81">        return dests;</span>
    }

    public static Object[] realize(Object[] objs, Class&lt;?&gt;[] types, Type[] gtypes) {
<span class="nc bnc" id="L85" title="All 4 branches missed.">        if (objs.length != types.length || objs.length != gtypes.length) {</span>
<span class="nc" id="L86">            throw new IllegalArgumentException(&quot;args.length != types.length&quot;);</span>
        }
<span class="nc" id="L88">        Object[] dests = new Object[objs.length];</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        for (int i = 0; i &lt; objs.length; i++) {</span>
<span class="nc" id="L90">            dests[i] = realize(objs[i], types[i], gtypes[i]);</span>
        }
<span class="nc" id="L92">        return dests;</span>
    }

    public static Object generalize(Object pojo) {
<span class="nc" id="L96">        return generalize(pojo, new IdentityHashMap&lt;Object, Object&gt;(), true);</span>
    }


    public static Object generalize(Object pojo, boolean addClass) {
<span class="nc" id="L101">        return generalize(pojo, new IdentityHashMap&lt;Object, Object&gt;(), addClass);</span>
    }


    @SuppressWarnings(&quot;unchecked&quot;)
    private static Object generalize(Object pojo, Map&lt;Object, Object&gt; history, boolean addClass) {
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (pojo == null) {</span>
<span class="nc" id="L108">            return null;</span>
        }

<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (pojo instanceof Enum&lt;?&gt;) {</span>
<span class="nc" id="L112">            return ((Enum&lt;?&gt;) pojo).name();</span>
        }
<span class="nc bnc" id="L114" title="All 4 branches missed.">        if (pojo.getClass().isArray() &amp;&amp; Enum.class.isAssignableFrom(pojo.getClass().getComponentType())) {</span>
<span class="nc" id="L115">            int len = Array.getLength(pojo);</span>
<span class="nc" id="L116">            String[] values = new String[len];</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L118">                values[i] = ((Enum&lt;?&gt;) Array.get(pojo, i)).name();</span>
            }
<span class="nc" id="L120">            return values;</span>
        }

<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (ReflectUtils.isPrimitives(pojo.getClass())) {</span>
<span class="nc" id="L124">            return pojo;</span>
        }

<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (pojo instanceof Class) {</span>
<span class="nc" id="L128">            return ((Class) pojo).getName();</span>
        }

<span class="nc" id="L131">        Object o = history.get(pojo);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (o != null) {</span>
<span class="nc" id="L133">            return o;</span>
        }
<span class="nc" id="L135">        history.put(pojo, pojo);</span>

<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (pojo.getClass().isArray()) {</span>
<span class="nc" id="L138">            int len = Array.getLength(pojo);</span>
<span class="nc" id="L139">            Object[] dest = new Object[len];</span>
<span class="nc" id="L140">            history.put(pojo, dest);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L142">                Object obj = Array.get(pojo, i);</span>
<span class="nc" id="L143">                dest[i] = generalize(obj, history, addClass);</span>
            }
<span class="nc" id="L145">            return dest;</span>
        }
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (pojo instanceof Collection&lt;?&gt;) {</span>
<span class="nc" id="L148">            Collection&lt;Object&gt; src = (Collection&lt;Object&gt;) pojo;</span>
<span class="nc" id="L149">            int len = src.size();</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            Collection&lt;Object&gt; dest = (pojo instanceof List&lt;?&gt;) ? new ArrayList&lt;Object&gt;(len) : new HashSet&lt;Object&gt;(len);</span>
<span class="nc" id="L151">            history.put(pojo, dest);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            for (Object obj : src) {</span>
<span class="nc" id="L153">                dest.add(generalize(obj, history, addClass));</span>
<span class="nc" id="L154">            }</span>
<span class="nc" id="L155">            return dest;</span>
        }
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (pojo instanceof Map&lt;?, ?&gt;) {</span>
<span class="nc" id="L158">            Map&lt;Object, Object&gt; src = (Map&lt;Object, Object&gt;) pojo;</span>
<span class="nc" id="L159">            Map&lt;Object, Object&gt; dest = createMap(src);</span>
<span class="nc" id="L160">            history.put(pojo, dest);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            for (Map.Entry&lt;Object, Object&gt; obj : src.entrySet()) {</span>
<span class="nc" id="L162">                dest.put(generalize(obj.getKey(), history, addClass), generalize(obj.getValue(), history, addClass));</span>
<span class="nc" id="L163">            }</span>
<span class="nc" id="L164">            return dest;</span>
        }
<span class="nc" id="L166">        Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L167">        history.put(pojo, map);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (addClass) {</span>
<span class="nc" id="L169">            map.put(&quot;class&quot;, pojo.getClass().getName());</span>
        }
<span class="nc bnc" id="L171" title="All 2 branches missed.">        for (Method method : pojo.getClass().getMethods()) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (ReflectUtils.isBeanPropertyReadMethod(method)) {</span>
                try {
<span class="nc" id="L174">                    map.put(ReflectUtils.getPropertyNameFromBeanReadMethod(method), generalize(method.invoke(pojo), history,addClass));</span>
<span class="nc" id="L175">                } catch (Exception e) {</span>
<span class="nc" id="L176">                    throw new RuntimeException(e.getMessage(), e);</span>
<span class="nc" id="L177">                }</span>
            }
        }
        // public field
<span class="nc bnc" id="L181" title="All 2 branches missed.">        for (Field field : pojo.getClass().getFields()) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (ReflectUtils.isPublicInstanceField(field)) {</span>
                try {
<span class="nc" id="L184">                    Object fieldValue = field.get(pojo);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                    if (history.containsKey(pojo)) {</span>
<span class="nc" id="L186">                        Object pojoGenerilizedValue = history.get(pojo);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                        if (pojoGenerilizedValue instanceof Map</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                                &amp;&amp; ((Map) pojoGenerilizedValue).containsKey(field.getName())) {</span>
<span class="nc" id="L189">                            continue;</span>
                        }
                    }
<span class="nc bnc" id="L192" title="All 2 branches missed.">                    if (fieldValue != null) {</span>
<span class="nc" id="L193">                        map.put(field.getName(), generalize(fieldValue, history, addClass));</span>
                    }
<span class="nc" id="L195">                } catch (Exception e) {</span>
<span class="nc" id="L196">                    throw new RuntimeException(e.getMessage(), e);</span>
<span class="nc" id="L197">                }</span>
            }
        }
<span class="nc" id="L200">        return map;</span>
    }

    public static Object realize(Object pojo, Class&lt;?&gt; type) {
<span class="nc" id="L204">        return realize0(pojo, type, null, new IdentityHashMap&lt;Object, Object&gt;());</span>
    }

    public static Object realize(Object pojo, Class&lt;?&gt; type, Type genericType) {
<span class="nc" id="L208">        return realize0(pojo, type, genericType, new IdentityHashMap&lt;Object, Object&gt;());</span>
    }

    private static class PojoInvocationHandler implements InvocationHandler {

        private Map&lt;Object, Object&gt; map;

<span class="nc" id="L215">        public PojoInvocationHandler(Map&lt;Object, Object&gt; map) {</span>
<span class="nc" id="L216">            this.map = map;</span>
<span class="nc" id="L217">        }</span>

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (method.getDeclaringClass() == Object.class) {</span>
<span class="nc" id="L223">                return method.invoke(map, args);</span>
            }
<span class="nc" id="L225">            String methodName = method.getName();</span>
<span class="nc" id="L226">            Object value = null;</span>
<span class="nc bnc" id="L227" title="All 4 branches missed.">            if (methodName.length() &gt; 3 &amp;&amp; methodName.startsWith(&quot;get&quot;)) {</span>
<span class="nc" id="L228">                value = map.get(methodName.substring(3, 4).toLowerCase() + methodName.substring(4));</span>
<span class="nc bnc" id="L229" title="All 4 branches missed.">            } else if (methodName.length() &gt; 2 &amp;&amp; methodName.startsWith(&quot;is&quot;)) {</span>
<span class="nc" id="L230">                value = map.get(methodName.substring(2, 3).toLowerCase() + methodName.substring(3));</span>
            } else {
<span class="nc" id="L232">                value = map.get(methodName.substring(0, 1).toLowerCase() + methodName.substring(1));</span>
            }
<span class="nc bnc" id="L234" title="All 4 branches missed.">            if (value instanceof Map&lt;?, ?&gt; &amp;&amp; !Map.class.isAssignableFrom(method.getReturnType())) {</span>
<span class="nc" id="L235">                value = realize0((Map&lt;String, Object&gt;) value, method.getReturnType(), null, new IdentityHashMap&lt;Object, Object&gt;());</span>
            }
<span class="nc" id="L237">            return value;</span>
        }
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private static Collection&lt;Object&gt; createCollection(Class&lt;?&gt; type, int len) {
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (type.isAssignableFrom(ArrayList.class)) {</span>
<span class="nc" id="L244">            return new ArrayList&lt;Object&gt;(len);</span>
        }
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (type.isAssignableFrom(HashSet.class)) {</span>
<span class="nc" id="L247">            return new HashSet&lt;Object&gt;(len);</span>
        }
<span class="nc bnc" id="L249" title="All 4 branches missed.">        if (!type.isInterface() &amp;&amp; !Modifier.isAbstract(type.getModifiers())) {</span>
            try {
<span class="nc" id="L251">                return (Collection&lt;Object&gt;) type.newInstance();</span>
<span class="nc" id="L252">            } catch (Exception e) {</span>
                // ignore
            }
        }
<span class="nc" id="L256">        return new ArrayList&lt;Object&gt;();</span>
    }

    private static Map createMap(Map src) {
<span class="nc" id="L260">        Class&lt;? extends Map&gt; cl = src.getClass();</span>
<span class="nc" id="L261">        Map result = null;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (HashMap.class == cl) {</span>
<span class="nc" id="L263">            result = new HashMap();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        } else if (Hashtable.class == cl) {</span>
<span class="nc" id="L265">            result = new Hashtable();</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">        } else if (IdentityHashMap.class == cl) {</span>
<span class="nc" id="L267">            result = new IdentityHashMap();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        } else if (LinkedHashMap.class == cl) {</span>
<span class="nc" id="L269">            result = new LinkedHashMap();</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        } else if (Properties.class == cl) {</span>
<span class="nc" id="L271">            result = new Properties();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        } else if (TreeMap.class == cl) {</span>
<span class="nc" id="L273">            result = new TreeMap();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        } else if (WeakHashMap.class == cl) {</span>
<span class="nc" id="L275">            return new WeakHashMap();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        } else if (ConcurrentHashMap.class == cl) {</span>
<span class="nc" id="L277">            result = new ConcurrentHashMap();</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        } else if (ConcurrentSkipListMap.class == cl) {</span>
<span class="nc" id="L279">            result = new ConcurrentSkipListMap();</span>
        } else {
            try {
<span class="nc" id="L282">                result = cl.newInstance();</span>
<span class="nc" id="L283">            } catch (Exception e) { /* ignore */ }</span>

<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (result == null) {</span>
                try {
<span class="nc" id="L287">                    Constructor&lt;?&gt; constructor = cl.getConstructor(Map.class);</span>
<span class="nc" id="L288">                    result = (Map) constructor.newInstance(Collections.EMPTY_MAP);</span>
<span class="nc" id="L289">                } catch (Exception e) { /* ignore */ }</span>
            }
        }

<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (result == null) {</span>
<span class="nc" id="L294">            result = new HashMap&lt;Object, Object&gt;();</span>
        }

<span class="nc" id="L297">        return result;</span>
    }

    @SuppressWarnings({&quot;unchecked&quot;, &quot;rawtypes&quot;})
    private static Object realize0(Object pojo, Class&lt;?&gt; type, Type genericType, final Map&lt;Object, Object&gt; history) {
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (pojo == null) {</span>
<span class="nc" id="L303">            return null;</span>
        }

<span class="nc bnc" id="L306" title="All 6 branches missed.">        if (type != null &amp;&amp; type.isEnum() &amp;&amp; pojo.getClass() == String.class) {</span>
<span class="nc" id="L307">            return Enum.valueOf((Class&lt;Enum&gt;) type, (String) pojo);</span>
        }

<span class="nc bnc" id="L310" title="All 4 branches missed.">        if (ReflectUtils.isPrimitives(pojo.getClass())</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                &amp;&amp; !(type != null &amp;&amp; type.isArray()</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">                &amp;&amp; type.getComponentType().isEnum()</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                &amp;&amp; pojo.getClass() == String[].class)) {</span>
<span class="nc" id="L314">            return CompatibleTypeUtils.compatibleTypeConvert(pojo, type);</span>
        }

<span class="nc" id="L317">        Object o = history.get(pojo);</span>

<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (o != null) {</span>
<span class="nc" id="L320">            return o;</span>
        }

<span class="nc" id="L323">        history.put(pojo, pojo);</span>

<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (pojo.getClass().isArray()) {</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">            if (Collection.class.isAssignableFrom(type)) {</span>
<span class="nc" id="L327">                Class&lt;?&gt; ctype = pojo.getClass().getComponentType();</span>
<span class="nc" id="L328">                int len = Array.getLength(pojo);</span>
<span class="nc" id="L329">                Collection dest = createCollection(type, len);</span>
<span class="nc" id="L330">                history.put(pojo, dest);</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L332">                    Object obj = Array.get(pojo, i);</span>
<span class="nc" id="L333">                    Object value = realize0(obj, ctype, null, history);</span>
<span class="nc" id="L334">                    dest.add(value);</span>
                }
<span class="nc" id="L336">                return dest;</span>
            } else {
<span class="nc bnc" id="L338" title="All 4 branches missed.">                Class&lt;?&gt; ctype = (type != null &amp;&amp; type.isArray() ? type.getComponentType() : pojo.getClass().getComponentType());</span>
<span class="nc" id="L339">                int len = Array.getLength(pojo);</span>
<span class="nc" id="L340">                Object dest = Array.newInstance(ctype, len);</span>
<span class="nc" id="L341">                history.put(pojo, dest);</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L343">                    Object obj = Array.get(pojo, i);</span>
<span class="nc" id="L344">                    Object value = realize0(obj, ctype, null, history);</span>
<span class="nc" id="L345">                    Array.set(dest, i, value);</span>
                }
<span class="nc" id="L347">                return dest;</span>
            }
        }

<span class="nc bnc" id="L351" title="All 2 branches missed.">        if (pojo instanceof Collection&lt;?&gt;) {</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (type.isArray()) {</span>
<span class="nc" id="L353">                Class&lt;?&gt; ctype = type.getComponentType();</span>
<span class="nc" id="L354">                Collection&lt;Object&gt; src = (Collection&lt;Object&gt;) pojo;</span>
<span class="nc" id="L355">                int len = src.size();</span>
<span class="nc" id="L356">                Object dest = Array.newInstance(ctype, len);</span>
<span class="nc" id="L357">                history.put(pojo, dest);</span>
<span class="nc" id="L358">                int i = 0;</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                for (Object obj : src) {</span>
<span class="nc" id="L360">                    Object value = realize0(obj, ctype, null, history);</span>
<span class="nc" id="L361">                    Array.set(dest, i, value);</span>
<span class="nc" id="L362">                    i++;</span>
<span class="nc" id="L363">                }</span>
<span class="nc" id="L364">                return dest;</span>
            } else {
<span class="nc" id="L366">                Collection&lt;Object&gt; src = (Collection&lt;Object&gt;) pojo;</span>
<span class="nc" id="L367">                int len = src.size();</span>
<span class="nc" id="L368">                Collection&lt;Object&gt; dest = createCollection(type, len);</span>
<span class="nc" id="L369">                history.put(pojo, dest);</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">                for (Object obj : src) {</span>
<span class="nc" id="L371">                    Type keyType = getGenericClassByIndex(genericType, 0);</span>
<span class="nc" id="L372">                    Class&lt;?&gt; keyClazz = obj.getClass();</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                    if (keyType instanceof Class) {</span>
<span class="nc" id="L374">                        keyClazz = (Class&lt;?&gt;) keyType;</span>
                    }
<span class="nc" id="L376">                    Object value = realize0(obj, keyClazz, keyType, history);</span>
<span class="nc" id="L377">                    dest.add(value);</span>
<span class="nc" id="L378">                }</span>
<span class="nc" id="L379">                return dest;</span>
            }
        }

<span class="nc bnc" id="L383" title="All 4 branches missed.">        if (pojo instanceof Map&lt;?, ?&gt; &amp;&amp; type != null) {</span>
<span class="nc" id="L384">            Object className = ((Map&lt;Object, Object&gt;) pojo).get(&quot;class&quot;);</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">            if (className instanceof String) {</span>
                try {
<span class="nc" id="L387">                    type = ClassHelper.forName((String) className);</span>
<span class="nc" id="L388">                } catch (ClassNotFoundException e) {</span>
                    // ignore
<span class="nc" id="L390">                }</span>
            }

            // special logic for enum
<span class="nc bnc" id="L394" title="All 2 branches missed.">            if (type.isEnum()) {</span>
<span class="nc" id="L395">                Object name = ((Map&lt;Object, Object&gt;) pojo).get(&quot;name&quot;);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                if (name != null) {</span>
<span class="nc" id="L397">                    return Enum.valueOf((Class&lt;Enum&gt;) type, name.toString());</span>
                }
            }
            Map&lt;Object, Object&gt; map;
            // when return type is not the subclass of return type from the signature and not an interface
<span class="nc bnc" id="L402" title="All 4 branches missed.">            if (!type.isInterface() &amp;&amp; !type.isAssignableFrom(pojo.getClass())) {</span>
                try {
<span class="nc" id="L404">                    map = (Map&lt;Object, Object&gt;) type.newInstance();</span>
<span class="nc" id="L405">                    Map&lt;Object, Object&gt; mapPojo = (Map&lt;Object, Object&gt;) pojo;</span>
<span class="nc" id="L406">                    map.putAll(mapPojo);</span>
<span class="nc" id="L407">                    map.remove(&quot;class&quot;);</span>
<span class="nc" id="L408">                } catch (Exception e) {</span>
                    //ignore error
<span class="nc" id="L410">                    map = (Map&lt;Object, Object&gt;) pojo;</span>
<span class="nc" id="L411">                }</span>
            } else {
<span class="nc" id="L413">                map = (Map&lt;Object, Object&gt;) pojo;</span>
            }

<span class="nc bnc" id="L416" title="All 4 branches missed.">            if (Map.class.isAssignableFrom(type) || type == Object.class) {</span>
<span class="nc" id="L417">                final Map&lt;Object, Object&gt; result = createMap(map);</span>
<span class="nc" id="L418">                history.put(pojo, result);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">                for (Map.Entry&lt;Object, Object&gt; entry : map.entrySet()) {</span>
<span class="nc" id="L420">                    Type keyType = getGenericClassByIndex(genericType, 0);</span>
<span class="nc" id="L421">                    Type valueType = getGenericClassByIndex(genericType, 1);</span>
                    Class&lt;?&gt; keyClazz;
<span class="nc bnc" id="L423" title="All 2 branches missed.">                    if (keyType instanceof Class) {</span>
<span class="nc" id="L424">                        keyClazz = (Class&lt;?&gt;) keyType;</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">                    } else if (keyType instanceof ParameterizedType) {</span>
<span class="nc" id="L426">                        keyClazz = (Class&lt;?&gt;) ((ParameterizedType) keyType).getRawType();</span>
                    } else {
<span class="nc bnc" id="L428" title="All 2 branches missed.">                        keyClazz = entry.getKey() == null ? null : entry.getKey().getClass();</span>
                    }
                    Class&lt;?&gt; valueClazz;
<span class="nc bnc" id="L431" title="All 2 branches missed.">                    if (valueType instanceof Class) {</span>
<span class="nc" id="L432">                        valueClazz = (Class&lt;?&gt;) valueType;</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">                    } else if (valueType instanceof ParameterizedType) {</span>
<span class="nc" id="L434">                        valueClazz = (Class&lt;?&gt;) ((ParameterizedType) valueType).getRawType();</span>
                    } else {
<span class="nc bnc" id="L436" title="All 2 branches missed.">                        valueClazz = entry.getValue() == null ? null : entry.getValue().getClass();</span>
                    }

<span class="nc bnc" id="L439" title="All 2 branches missed.">                    Object key = keyClazz == null ? entry.getKey() : realize0(entry.getKey(), keyClazz, keyType, history);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                    Object value = valueClazz == null ? entry.getValue() : realize0(entry.getValue(), valueClazz, valueType, history);</span>
<span class="nc" id="L441">                    result.put(key, value);</span>
<span class="nc" id="L442">                }</span>
<span class="nc" id="L443">                return result;</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">            } else if (type.isInterface()) {</span>
<span class="nc" id="L445">                Object dest = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), new Class&lt;?&gt;[]{type}, new PojoInvocationHandler(map));</span>
<span class="nc" id="L446">                history.put(pojo, dest);</span>
<span class="nc" id="L447">                return dest;</span>
            } else {
<span class="nc" id="L449">                Object dest = newInstance(type);</span>
<span class="nc" id="L450">                history.put(pojo, dest);</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">                for (Map.Entry&lt;Object, Object&gt; entry : map.entrySet()) {</span>
<span class="nc" id="L452">                    Object key = entry.getKey();</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                    if (key instanceof String) {</span>
<span class="nc" id="L454">                        String name = (String) key;</span>
<span class="nc" id="L455">                        Object value = entry.getValue();</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                        if (value != null) {</span>
<span class="nc" id="L457">                            Method method = getSetterMethod(dest.getClass(), name, value.getClass());</span>
<span class="nc" id="L458">                            Field field = getField(dest.getClass(), name);</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">                            if (method != null) {</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">                                if (!method.isAccessible()) {</span>
<span class="nc" id="L461">                                    method.setAccessible(true);</span>
                                }
<span class="nc" id="L463">                                Type ptype = method.getGenericParameterTypes()[0];</span>
<span class="nc" id="L464">                                value = realize0(value, method.getParameterTypes()[0], ptype, history);</span>
                                try {
<span class="nc" id="L466">                                    method.invoke(dest, value);</span>
<span class="nc" id="L467">                                } catch (Exception e) {</span>
<span class="nc" id="L468">                                    e.printStackTrace();</span>
<span class="nc" id="L469">                                    throw new RuntimeException(&quot;Failed to set pojo &quot; + dest.getClass().getSimpleName() + &quot; property &quot; + name</span>
<span class="nc" id="L470">                                            + &quot; value &quot; + value + &quot;(&quot; + value.getClass() + &quot;), cause: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L471">                                }</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">                            } else if (field != null) {</span>
<span class="nc" id="L473">                                value = realize0(value, field.getType(), field.getGenericType(), history);</span>
                                try {
<span class="nc" id="L475">                                    field.set(dest, value);</span>
<span class="nc" id="L476">                                } catch (IllegalAccessException e) {</span>
<span class="nc" id="L477">                                    throw new RuntimeException(&quot;Failed to set field &quot; + name + &quot; of pojo &quot; + dest.getClass().getName() + &quot; : &quot; + e.getMessage(), e);</span>
<span class="nc" id="L478">                                }</span>
                            }
                        }
                    }
<span class="nc" id="L482">                }</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">                if (dest instanceof Throwable) {</span>
<span class="nc" id="L484">                    Object message = map.get(&quot;message&quot;);</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">                    if (message instanceof String) {</span>
                        try {
<span class="nc" id="L487">                            Field field = Throwable.class.getDeclaredField(&quot;detailMessage&quot;);</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">                            if (!field.isAccessible()) {</span>
<span class="nc" id="L489">                                field.setAccessible(true);</span>
                            }
<span class="nc" id="L491">                            field.set(dest, message);</span>
<span class="nc" id="L492">                        } catch (Exception e) {</span>
<span class="nc" id="L493">                        }</span>
                    }
                }
<span class="nc" id="L496">                return dest;</span>
            }
        }
<span class="nc" id="L499">        return pojo;</span>
    }

    /**
     * Get parameterized type
     *
     * @param genericType generic type
     * @param index       index of the target parameterized type
     * @return Return Person.class for List&lt;Person&gt;, return Person.class for Map&lt;String, Person&gt; when index=0
     */
    private static Type getGenericClassByIndex(Type genericType, int index) {
<span class="nc" id="L510">        Type clazz = null;</span>
        // find parameterized type
<span class="nc bnc" id="L512" title="All 2 branches missed.">        if (genericType instanceof ParameterizedType) {</span>
<span class="nc" id="L513">            ParameterizedType t = (ParameterizedType) genericType;</span>
<span class="nc" id="L514">            Type[] types = t.getActualTypeArguments();</span>
<span class="nc" id="L515">            clazz = types[index];</span>
        }
<span class="nc" id="L517">        return clazz;</span>
    }

    private static Object newInstance(Class&lt;?&gt; cls) {
        try {
<span class="nc" id="L522">            return cls.newInstance();</span>
<span class="nc" id="L523">        } catch (Throwable t) {</span>
            try {
<span class="nc" id="L525">                Constructor&lt;?&gt;[] constructors = cls.getDeclaredConstructors();</span>
<span class="nc bnc" id="L526" title="All 4 branches missed.">                if (constructors != null &amp;&amp; constructors.length == 0) {</span>
<span class="nc" id="L527">                    throw new RuntimeException(&quot;Illegal constructor: &quot; + cls.getName());</span>
                }
<span class="nc" id="L529">                Constructor&lt;?&gt; constructor = constructors[0];</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">                if (constructor.getParameterTypes().length &gt; 0) {</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">                    for (Constructor&lt;?&gt; c : constructors) {</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">                        if (c.getParameterTypes().length &lt; constructor.getParameterTypes().length) {</span>
<span class="nc" id="L533">                            constructor = c;</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">                            if (constructor.getParameterTypes().length == 0) {</span>
<span class="nc" id="L535">                                break;</span>
                            }
                        }
                    }
                }
<span class="nc" id="L540">                constructor.setAccessible(true);</span>
<span class="nc" id="L541">                return constructor.newInstance(new Object[constructor.getParameterTypes().length]);</span>
<span class="nc" id="L542">            } catch (InstantiationException e) {</span>
<span class="nc" id="L543">                throw new RuntimeException(e.getMessage(), e);</span>
<span class="nc" id="L544">            } catch (IllegalAccessException e) {</span>
<span class="nc" id="L545">                throw new RuntimeException(e.getMessage(), e);</span>
<span class="nc" id="L546">            } catch (InvocationTargetException e) {</span>
<span class="nc" id="L547">                throw new RuntimeException(e.getMessage(), e);</span>
            }
        }
    }

    private static Method getSetterMethod(Class&lt;?&gt; cls, String property, Class&lt;?&gt; valueCls) {
<span class="nc" id="L553">        String name = &quot;set&quot; + property.substring(0, 1).toUpperCase() + property.substring(1);</span>
<span class="nc" id="L554">        Method method = NAME_METHODS_CACHE.get(cls.getName() + &quot;.&quot; + name + &quot;(&quot; + valueCls.getName() + &quot;)&quot;);</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (method == null) {</span>
            try {
<span class="nc" id="L557">                method = cls.getMethod(name, valueCls);</span>
<span class="nc" id="L558">            } catch (NoSuchMethodException e) {</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">                for (Method m : cls.getMethods()) {</span>
<span class="nc bnc" id="L560" title="All 4 branches missed.">                    if (ReflectUtils.isBeanPropertyWriteMethod(m) &amp;&amp; m.getName().equals(name)) {</span>
<span class="nc" id="L561">                        method = m;</span>
                    }
                }
<span class="nc" id="L564">            }</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">            if (method != null) {</span>
<span class="nc" id="L566">                NAME_METHODS_CACHE.put(cls.getName() + &quot;.&quot; + name + &quot;(&quot; + valueCls.getName() + &quot;)&quot;, method);</span>
            }
        }
<span class="nc" id="L569">        return method;</span>
    }

    private static Field getField(Class&lt;?&gt; cls, String fieldName) {
<span class="nc" id="L573">        Field result = null;</span>
<span class="nc bnc" id="L574" title="All 4 branches missed.">        if (CLASS_FIELD_CACHE.containsKey(cls) &amp;&amp; CLASS_FIELD_CACHE.get(cls).containsKey(fieldName)) {</span>
<span class="nc" id="L575">            return CLASS_FIELD_CACHE.get(cls).get(fieldName);</span>
        }
        try {
<span class="nc" id="L578">            result = cls.getDeclaredField(fieldName);</span>
<span class="nc" id="L579">            result.setAccessible(true);</span>
<span class="nc" id="L580">        } catch (NoSuchFieldException e) {</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">            for (Field field : cls.getFields()) {</span>
<span class="nc bnc" id="L582" title="All 4 branches missed.">                if (fieldName.equals(field.getName()) &amp;&amp; ReflectUtils.isPublicInstanceField(field)) {</span>
<span class="nc" id="L583">                    result = field;</span>
<span class="nc" id="L584">                    break;</span>
                }
            }
<span class="nc" id="L587">        }</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L589">            ConcurrentMap&lt;String, Field&gt; fields = CLASS_FIELD_CACHE.get(cls);</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">            if (fields == null) {</span>
<span class="nc" id="L591">                fields = new ConcurrentHashMap&lt;String, Field&gt;();</span>
<span class="nc" id="L592">                CLASS_FIELD_CACHE.putIfAbsent(cls, fields);</span>
            }
<span class="nc" id="L594">            fields = CLASS_FIELD_CACHE.get(cls);</span>
<span class="nc" id="L595">            fields.putIfAbsent(fieldName, result);</span>
        }
<span class="nc" id="L597">        return result;</span>
    }

    public static boolean isPojo(Class&lt;?&gt; cls) {
<span class="nc bnc" id="L601" title="All 2 branches missed.">        return !ReflectUtils.isPrimitives(cls)</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">                &amp;&amp; !Collection.class.isAssignableFrom(cls)</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">                &amp;&amp; !Map.class.isAssignableFrom(cls);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>