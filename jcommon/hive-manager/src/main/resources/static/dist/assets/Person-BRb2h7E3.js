import{d as Y,r as h,o as Z,R as $,_ as ee,c as I,e as U,f as m,v as x,g as D,w as j,t as A,F as te,q as se,K as ne,h as C,s as oe,k as re}from"./index-Co6ij2vp.js";import{w as ie}from"./wsUtils-CMNCxRvk.js";import{v as F}from"./v4-CtRu48qb.js";function ae(B,f=24e3,p=1){const n=atob(B),c=new Uint8Array(n.length);for(let s=0;s<n.length;s++)c[s]=n.charCodeAt(s);const g=new ArrayBuffer(44+c.length),t=new DataView(g);function u(s,r,i){for(let l=0;l<i.length;l++)s.setUint8(r+l,i.charCodeAt(l))}u(t,0,"RIFF"),t.setUint32(4,36+c.length,!0),u(t,8,"WAVE"),u(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,p,!0),t.setUint32(24,f,!0),t.setUint32(28,f*p*2,!0),t.setUint16(32,p*2,!0),t.setUint16(34,16,!0),u(t,36,"data"),t.setUint32(40,c.length,!0);for(let s=0;s<c.length;s+=2){const r=c[s]|c[s+1]<<8;t.setInt16(44+s,r,!0)}const o=new Blob([t],{type:"audio/wav"});return new Promise(s=>{const r=new FileReader;r.onloadend=()=>{const i=r.result.split(",")[1];s(i)},r.readAsDataURL(o)})}function ce(B,f=24e3,p=1){let n=0;const c=B.map(i=>{const l=atob(i),y=new Uint8Array(l.length);for(let w=0;w<l.length;w++)y[w]=l.charCodeAt(w);return n+=y.length,y}),g=new Uint8Array(n);let t=0;for(const i of c)g.set(i,t),t+=i.length;const u=new ArrayBuffer(44+g.length),o=new DataView(u);function s(i,l,y){for(let w=0;w<y.length;w++)i.setUint8(l+w,y.charCodeAt(w))}s(o,0,"RIFF"),o.setUint32(4,36+g.length,!0),s(o,8,"WAVE"),s(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,p,!0),o.setUint32(24,f,!0),o.setUint32(28,f*p*2,!0),o.setUint16(32,p*2,!0),o.setUint16(34,16,!0),s(o,36,"data"),o.setUint32(40,g.length,!0);for(let i=0;i<g.length;i+=2){const l=g[i]|g[i+1]<<8;o.setInt16(44+i,l,!0)}const r=new Blob([o],{type:"audio/wav"});return new Promise(i=>{const l=new FileReader;l.onloadend=()=>{const y=l.result.split(",")[1];i(y)},l.readAsDataURL(r)})}const ue=Y({__name:"Person",setup(B,{expose:f}){f();const p=h(!1),n=h(!1),c=h(null),g=h(F());let t=null,u=null,o=null,s=[],r=null;const i={event_id:g.value,type:"input_audio_buffer.append",audio:""},l=e=>({type:"conversation.item.create",item:{type:"message",role:"user",status:"completed",content:[{type:"input_audio",audio:e}]}}),y=e=>({type:"conversation.item.create",item:{type:"message",role:"user",status:"completed",content:[{type:"input_text",text:e}]}}),w={event_id:g.value,type:"input_audio_buffer.commit"},K=h(""),G=h(""),H=h(0),q=h(0),P=h(""),W=h(""),T=h([]),S=h(""),k=(e,a,d,v)=>{T.value.push({id:e,type:a,content:d,audio:v||"",timestamp:Date.now()})},E=(e,a,d,v)=>{const b=T.value.find(_=>_.id===e);b?(b.content+=d,v&&(b.audio=v)):k(e,a,d,v)},V=async()=>{try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(a=>a.stop()),n.value=!0,!0}catch(e){return console.error("麦克风权限检查失败:",e),n.value=!1,!1}},Q=async()=>{p.value?L():await N()},N=async()=>{try{if(!await V())return;const a=await navigator.mediaDevices.getUserMedia({audio:!0});r=a,t=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}),o=t.createMediaStreamSource(a),u=t.createScriptProcessor(4096,1,1),s=[],u.onaudioprocess=d=>{const v=d.inputBuffer.getChannelData(0),b=new Int16Array(v.length);for(let _=0;_<v.length;_++){let R=Math.max(-1,Math.min(1,v[_]));b[_]=R<0?R*32768:R*32767}s.push(b)},o.connect(u),u.connect(t.destination),p.value=!0}catch(e){console.error("获取麦克风权限失败:",e),n.value=!1}},L=()=>{if(!p.value)return;p.value=!1,u&&o&&(u.disconnect(),o.disconnect()),t&&t.close(),r&&(r.getTracks().forEach(_=>_.stop()),r=null);const e=s.reduce((_,R)=>_+R.length,0),a=new Int16Array(e);let d=0;for(const _ of s)a.set(_,d),d+=_.length;const v=new Uint8Array(a.buffer),b=btoa(String.fromCharCode(...v));setTimeout(()=>{O(b),s=[]},0)},O=async e=>{var v,b;if(!e)return;const a=l(e),d=await ae(e,24e3,1);k(F(),"audio","发送音频数据",`data:audio/wav;base64,${d}`),(v=c.value)==null||v.send(JSON.stringify(a)),(b=c.value)==null||b.send(JSON.stringify({type:"response.create",status:"completed"}))},M=new Map,J=()=>{c.value||(c.value=ie("/api/manager/ws/realtime/minimaxi",()=>{console.log("WebSocket连接成功"),k(F(),"system","WebSocket连接成功")},()=>{console.log("WebSocket连接关闭"),k(F(),"system","WebSocket连接关闭"),c.value=null},async e=>{if(console.log("WebSocket message received:",e),typeof e=="string")try{e=JSON.parse(e)}catch(a){console.error("WebSocket消息解析失败:",a)}switch(e.type){case"response.created":case"conversation.item.created":case"response.done":case"response.output_item.done":case"response.audio_transcript.done":break;case"response.audio.delta":if(e.delta){const d=M.get(e.response_id)||[];d.push(e.delta),M.set(e.response_id,d)}break;case"response.audio.done":const a=M.get(e.response_id)||[];M.delete(e.response_id),a&&a.length>0&&ce(a,24e3,1).then(d=>{k(e.response_id,"audio","收到音频数据",`data:audio/wav;base64,${d}`)});break;case"response.audio_transcript.delta":e.delta&&E(e.response_id,"transcript",e.delta);break;case"response.error":e.error&&(console.error("服务端错误:",e.error),P.value=e.error,k(e.response_id,"error",e.error));break;case"response.status":e.status&&(console.log("服务端状态:",e.status),W.value=e.status,k(e.response_id,"status",e.status));break;case"session.created":case"session.updated":e.session&&k(e.response_id,"session",`${e.type}, 会话ID: ${e.session.id}`);break;default:console.log("未处理的消息类型:",e.type),k(e.response_id,"unknown",`未处理的消息类型: ${e.type}`)}}))},X=()=>{var a,d;if(!S.value.trim())return;const e=y(S.value);k(F(),"text",S.value),(a=c.value)==null||a.send(JSON.stringify(e)),(d=c.value)==null||d.send(JSON.stringify({type:"response.create",response:{status:"completed"}})),S.value=""};Z(()=>{V(),J()}),$(()=>{p.value&&(p.value=!1,u&&o&&(u.disconnect(),o.disconnect()),t&&t.close(),r&&(r.getTracks().forEach(e=>e.stop()),r=null),s=[]),c.value&&c.value.close()});const z={isRecording:p,hasPermission:n,socket:c,uuid:g,get audioContext(){return t},set audioContext(e){t=e},get processor(){return u},set processor(e){u=e},get input(){return o},set input(e){o=e},get pcmChunks(){return s},set pcmChunks(e){s=e},get streamRef(){return r},set streamRef(e){r=e},audioAppend:i,conversationItem:l,conversationTextItem:y,audioCommit:w,chatContent:K,modelInfo:G,tokenCount:H,asrTime:q,errorMessage:P,statusMessage:W,messageHistory:T,textInput:S,addMessage:k,appendMessage:E,checkMicrophonePermission:V,toggleRecording:Q,startRecording:N,stopRecording:L,sendAudioData:O,responseAudio:M,wsConnect:J,sendText:X};return Object.defineProperty(z,"__isScriptSetup",{enumerable:!1,value:!0}),z}}),le={class:"microphone-container"},de={class:"mic-icon"},pe={key:0,class:"wave-container"},me={key:0,class:"permission-tip"},fe={key:1,class:"chat-container"},ge={class:"chat-message"},ve={class:"message-content"},_e={class:"message-info"},he={class:"message-history"},ye={class:"message-time"},we={class:"message-content"},ke=["src"],be={key:2,class:"error-message"},Ue={key:3,class:"status-message"},Ce={class:"text-input-container"};function Ae(B,f,p,n,c,g){const t=I("Mic"),u=I("el-icon"),o=I("el-input"),s=I("el-button");return C(),U("div",le,[m("div",{class:"microphone",onClick:n.toggleRecording},[m("div",de,[D(u,{size:"50px"},{default:j(()=>[D(t)]),_:1})]),n.isRecording?(C(),U("div",pe,f[1]||(f[1]=[m("div",{class:"wave"},null,-1),m("div",{class:"wave"},null,-1),m("div",{class:"wave"},null,-1)]))):x("",!0)]),n.hasPermission?x("",!0):(C(),U("div",me," 请允许使用麦克风权限 ")),n.chatContent?(C(),U("div",fe,[m("div",ge,[m("div",ve,A(n.chatContent),1),m("div",_e,[m("span",null,"模型: "+A(n.modelInfo),1),m("span",null,"Token数: "+A(n.tokenCount),1),m("span",null,"ASR时间: "+A(n.asrTime)+"ms",1)])])])):x("",!0),m("div",he,[(C(!0),U(te,null,se(n.messageHistory,(r,i)=>(C(),U("div",{key:i,class:oe(["message-item",r.type])},[m("div",ye,A(new Date(r.timestamp).toLocaleTimeString()),1),m("div",we,A(r.content),1),r.audio?(C(),U("audio",{key:0,src:r.audio,controls:"",autoplay:""},null,8,ke)):x("",!0)],2))),128))]),n.errorMessage?(C(),U("div",be,A(n.errorMessage),1)):x("",!0),n.statusMessage?(C(),U("div",Ue,A(n.statusMessage),1)):x("",!0),m("div",Ce,[D(o,{modelValue:n.textInput,"onUpdate:modelValue":f[0]||(f[0]=r=>n.textInput=r),placeholder:"请输入文本",onKeyup:ne(n.sendText,["enter"]),clearable:"",style:{"margin-right":"10px"}},null,8,["modelValue"]),D(s,{type:"primary",onClick:n.sendText},{default:j(()=>f[2]||(f[2]=[re("发送")])),_:1})])])}const Me=ee(ue,[["render",Ae],["__file","/Users/zhangzhiyong/IdeaProjects/open/mone/jcommon/hive-manager/src/main/resources/static/src/views/Person.vue"]]);export{Me as default};
